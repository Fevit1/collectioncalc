# Claude Working Notes - CollectionCalc Project

## IMPORTANT RULES
1. **Always describe what I plan to build and wait for Mike's approval BEFORE writing any code. Do not build until approved.**
2. **Break large code changes into small chunks** to avoid "thinking longer than usual" failures.
3. **Update this file at checkpoints** (see Checkpoint System below).
4. **Proactively push back and provide input** - Mike wants Claude to flag potential issues, suggest alternatives, and ask "have you considered..." when there are trade-offs. Don't just execute - use knowledge from other projects and patterns.
5. **Follow brand guidelines** - All user-facing text, UI elements, animations, and design decisions should align with BRAND_GUIDELINES.md. Check terminology, tone, and visual principles before implementing.
6. **Verify file integrity before delivering** - Check line count, verify proper closing brackets/braces, and compare to original if editing. Files have been truncated in the past.

## Checkpoint System
Update CLAUDE_NOTES.md when:
- ‚úÖ After any context compacting (conversation got long)
- ‚úÖ After completing a major feature
- ‚úÖ Before ending a session
- ‚úÖ If Mike says "let's checkpoint" or "update notes"

This ensures we can recover quickly if a conversation fails or needs to restart.

## About Mike
- **Name:** Mike (legal name Don, goes by Mike)
- **Role:** Product Manager in high tech, manages people (not hands-on dev)
- **Background:** Former eBay employee (marketing/content supply chain, not engineering)
- **Technical comfort:** Decent SQL skills, uses DBeaver for PostgreSQL queries
- **Strengths:** Product vision, feature prioritization, testing, user feedback, UI/UX decisions
- **Learning style:** Appreciates guidance but wants Claude to recognize when he's mastered something and stop over-explaining
- **Collaboration style:** Wants Claude to push back on decisions (UI, data flow, database, backend) and proactively share knowledge

## What Mike's Comfortable With
- ‚úÖ Render dashboard (deployments, environment variables, redeploys)
- ‚úÖ Git workflow (add, commit, push)
- ‚úÖ PowerShell aliases (`purge`, `deploy`)
- ‚úÖ Testing the app and providing feedback
- ‚úÖ SQL concepts and DBeaver
- ‚úÖ Product decisions and prioritization

## Where They Need More Guidance
- ‚ö†Ô∏è Complex Python debugging - explain error meanings
- ‚ö†Ô∏è Architecture decisions - explain trade-offs

## Project: CollectionCalc / Slab Worthy

### Core Info
- **What it is:** AI-powered comic book valuation and pre-grading assessment tool
- **Stack:** Python/Flask backend, vanilla HTML/JS frontend, PostgreSQL database
- **Hosted on:** Render.com ($7/mo Starter plan - NO cold starts)
- **Live URL:** https://collectioncalc.com
- **Version:** 2.97.0

### Key Product Features
- **Manual Entry** - Type title/issue/grade for valuation
- **Photo Upload** - AI extracts comic info from cover photo
- **Slab Worthy?** - 4-photo grading assessment flow (Patent Pending, filed Jan 27, 2026)
- **Slab Report** - Output of Slab Worthy with grade estimate and recommendation
- **Whatnot Extension** - Browser extension for live stream valuations

### Key Files
**Frontend (Cloudflare Pages):**
- `app.html` - Main frontend
- `styles.css` - Styling
- `js/utils.js` - Shared state, image processing, UI helpers
- `js/auth.js` - Authentication, user menu, collection
- `js/app.js` - eBay, photo upload, valuation, manual entry
- `js/grading.js` - Slab Worthy 4-photo flow, grade report

**Backend (Render):**
- `wsgi.py` - Flask app entry point
- `ebay_valuation.py` - Backend valuation logic
- `comic_extraction.py` - AI photo analysis
- `auth.py` - Authentication
- `admin.py` - Admin panel

### Database Info
- **Host:** Render PostgreSQL
- **Tool:** DBeaver for queries
- **Key table:** `search_cache` (title, issue, grade, estimated_value, fair_value, high_value, created_at)
- **Cache duration:** 48 hours

### Brand Guidelines Summary
Reference BRAND_GUIDELINES.md for full details. Key points:
- **Voice:** Expert, approachable, honest, helpful (not salesy or hyperbolic)
- **Terminology:** Use "assess" or "check" not "grade" (CGC grades, we assess)
- **Animations:** Purposeful and informative, NOT gambling metaphors (no slots, dice, spinning wheels)
- **Loading text:** "Analyzing..." matches existing patterns
- **Patent Pending:** Display on Slab Worthy feature, not on Slab Report output

## Previous Session (January 28, 2026 - Sessions 13-14)

### Bugs Fixed
1. ‚úÖ Button text: "Grade Another" ‚Üí "Check Another"
2. ‚úÖ FMV cache key mismatch: Added grade normalization
3. ‚úÖ Image rotation: Added "‚Üª Rotate" button for manual rotation
4. ‚úÖ Rotation banner update: Comic ID banners now update after rotation
5. ‚úÖ Loading state: Show "Analyzing..." during rotation re-analysis
6. ‚úÖ Patent Pending placement: Moved to top of Slab Worthy flow
7. ‚úÖ Auto-rotate landscape‚Üíportrait
8. ‚úÖ Auto-detect upside-down via AI
9. ‚úÖ Split app.js into 4 modules (utils, auth, app, grading)

## Current Session (January 29, 2026 - Sessions 15-16)

### Bugs Fixed Today
1. ‚úÖ **Login persistence** - Token wasn't loading from localStorage on page init (utils.js already had fix, auth.js had redundant early return)
2. ‚úÖ **Mobile extraction "bug"** - Was actually auth issue; works when logged in
3. ‚úÖ **Rotation detection false positive** - Updated prompt to check TEXT only, not artistic elements (Avengers #145 fix)
4. ‚úÖ **Server slowdown identified** - Whatnot extension polling with `issue=null` was hammering server

### Features Added Today
1. ‚úÖ **Upload from Gallery** - Slab Worthy now has two buttons: "Take Photo" and "Upload from Gallery"
2. ‚úÖ **Auto-rotation for all steps** - Steps 2-4 now have `is_upside_down` check in prompts (needs testing)

### Known Issues (Bug List)
- üêõ **Auto-rotation steps 2-4** - Added code but not working; needs debugging
- üêõ **Whatnot extension** - Polling with null issue, doesn't stop when tab closed
- üêõ **Debug alerts still in code** - Remove once stable
- üêõ **Slab Worthy UI polish needed** - Camera/Gallery buttons need refinement

### Testing Notes
- USB debugging failed (authorization popup never appeared)
- On-screen alert() debugging worked great for mobile
- Login persistence confirmed working on both desktop and mobile
- Mobile extraction works when logged in

## Pending Work

### High Priority
- [ ] Fix auto-rotation for steps 2-4
- [ ] Remove debug alerts from grading.js
- [ ] Fix Whatnot extension (null issue polling, stop on tab close)
- [ ] Slab Worthy UI polish

### Medium Priority
- [ ] High-value comic testing for ROI validation
- [ ] FAQ content (pressing, newsstand vs direct, valuation methodology, grade scale, CGC costs)
- [ ] Mobile visual/layout review

### Low Priority
- [ ] Pricing model decisions
- [ ] Business model canvas
- [ ] Competitive analysis (CovrPrice, GoCollect, Key Collector, CLZ, ComicMint AI)

## Useful SQL Queries

```sql
-- Check for bad cached values
SELECT title, issue, estimated_value, fair_value FROM search_cache 
WHERE estimated_value = 0 OR fair_value = 0;

-- Recent cache entries
SELECT title, issue, grade, estimated_value, created_at 
FROM search_cache ORDER BY created_at DESC LIMIT 20;
```

## Deployment Commands
```powershell
# Deploy and clear cache
git add .; git commit -m "message"; git push; purge

# Just clear Cloudflare cache
purge
```

---
*Last updated: January 29, 2026 (Session 16)*
