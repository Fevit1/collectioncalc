# Claude Working Notes - CollectionCalc Project

## Executive Summary

**Purpose:** This document helps Claude quickly get up to speed when starting a new session with Mike on the CollectionCalc project.

**The Project:** CollectionCalc is an AI-powered comic book valuation tool. The flagship feature "Slab Worthy?" uses patent-pending multi-angle photography to assess whether comics are worth professional grading.

**The Human:** Mike is a Product Manager (not a developer). He's comfortable with Git, Render deployments, and SQL queries, but needs guidance on complex debugging and architecture decisions. He wants Claude to push back and share knowledge proactively.

**Current State (v2.99.0):**
- Core features working: Manual Entry, Photo Upload, Slab Worthy
- Single source of truth achieved for all extraction (comic_extraction.py)
- Writer/Artist extraction working
- Barcode infrastructure ready but blocked on Docker deployment
- **eBay Collector extension v1.0.3 LIVE** ‚Äî passively collects sold listings with R2 image backup
- Whatnot Valuator extension v2.41.2 deployed (storage quota fix)

**Critical Priority:** Barcode scanning via Docker. Without it, we can't detect reprints (Spawn #1: $25 reprint vs $300 first print). This is the #1 differentiator vs competition.

**Key Rules:**
1. Get approval before coding
2. Render auto-deploy is OFF - always run `deploy` command
3. Don't accept limitations - research alternatives
4. Update this doc at session end

---

## Important Rules

1. **Always describe what I plan to build and wait for Mike's approval BEFORE writing any code.**
2. **Break large code changes into small chunks** to avoid "thinking longer than usual" failures.
3. **Update this file at checkpoints** - after compacting, features, or session end.
4. **Proactively push back** - flag issues, suggest alternatives, share knowledge from other projects.
5. **Follow brand guidelines** - check BRAND_GUIDELINES.md for voice, terminology, design.
6. **Verify file integrity** - check line counts, closing brackets. Files have been truncated before.
7. **Render auto-deploy is DISABLED** - Always include `deploy` command after `git push`.
8. **Don't accept limitations** - research alternative tools/libraries/APIs. Don't settle.
9. **Reference COMPETITORS.md** - check it when discussing market positioning.

---

## About Mike

- **Role:** Product Manager in high tech (manages people, not hands-on dev)
- **Background:** Former eBay (marketing/content supply chain, not engineering)
- **Technical comfort:** Decent SQL skills, uses DBeaver for PostgreSQL queries

**Comfortable with:**
- ‚úÖ Render dashboard (deployments, env vars, redeploys)
- ‚úÖ Git workflow (add, commit, push)
- ‚úÖ PowerShell aliases (`purge`, `deploy`)
- ‚úÖ Testing and providing feedback
- ‚úÖ Product decisions and prioritization

**Needs guidance on:**
- ‚ö†Ô∏è Complex Python debugging - explain error meanings
- ‚ö†Ô∏è Architecture decisions - explain trade-offs

**Collaboration style:** Wants Claude to push back on decisions and proactively share knowledge. Appreciates when Claude recognizes he's mastered something and stops over-explaining.

---

## Project Overview

### CollectionCalc / Slab Worthy
- **What:** AI-powered comic book valuation and pre-grading assessment
- **Stack:** Python/Flask backend, vanilla HTML/JS frontend, PostgreSQL
- **Hosting:** Render.com ($7/mo Starter), Cloudflare Pages
- **URL:** https://collectioncalc.com
- **Version:** 2.99.0

### Key Features
| Feature | Description |
|---------|-------------|
| Manual Entry | Type title/issue/grade for valuation |
| Photo Upload | AI extracts comic info from cover photo |
| Slab Worthy? | 4-photo grading assessment (Patent Pending) |
| Slab Report | Grade estimate + economic recommendation |
| Whatnot Extension | Browser extension for live stream valuations |
| **eBay Collector** | **Passive data collection from eBay sold listings with R2 backup** |

### Key Files
**Frontend (Cloudflare Pages):**
- `app.html` - Main frontend
- `styles.css` - Styling  
- `js/utils.js` - Shared state, image processing
- `js/auth.js` - Authentication, user menu
- `js/app.js` - Photo upload, valuation, manual entry
- `js/grading.js` - Slab Worthy 4-photo flow

**Backend (Render):**
- `wsgi.py` - Flask app entry point
- `comic_extraction.py` - AI photo analysis (SINGLE SOURCE OF TRUTH)
- `ebay_valuation.py` - Valuation logic
- `r2_storage.py` - Cloudflare R2 image uploads
- `auth.py` - Authentication
- `admin.py` - Admin panel

**Browser Extensions:**
- `ebay-collector/` - eBay sold listings collector (v1.0.3)
- `whatnot-valuator/` - Whatnot live stream valuations (v2.41.2)

---

## Session 21 Summary (February 1, 2026)

### eBay Collector Extension ‚Äî FULLY WORKING ‚úÖ

**Extension v1.0.3:**
- Fixed HTML selectors for eBay's new structure (`li.s-card` instead of `.s-item`)
- Fixed API URL (was pointing to frontend instead of Render backend)
- Fixed popup.js Sync button URL

**Backend:**
- Added `/api/ebay-sales/batch` endpoint with parallel R2 image backup
- Added `/api/ebay-sales/stats` endpoint
- Silenced eBay `MARKETPLACE_ACCOUNT_DELETION` notification spam

**Database:**
- `ebay_sales` table with: ebay_item_id, raw_title, parsed_title, issue_number, publisher, sale_price, sale_date, condition, graded, grade, listing_url, image_url, r2_image_url, content_hash
- `comic_fmv` view for 90-day rolling FMV calculations
- Added `r2_image_url` column for permanent image storage

**R2 Image Backup:**
- Parallel processing (5 concurrent downloads)
- Images stored at `ebay-covers/{ebay_item_id}.webp`
- ~10-15 seconds for 60 images instead of 60+ seconds

**How to use:**
1. Install extension from `ebay-collector-v1.0.3.zip`
2. Browse eBay sold listings (search anything + "sold", click Sold Items filter)
3. Green toast shows collected count
4. Click extension icon ‚Üí Sync Now to push to database

### Whatnot Valuator Extension ‚Äî Storage Fix ‚úÖ
- Fixed Chrome local storage quota exceeded error (v2.41.2)
- Root cause: Storing full base64 images (500MB+ when Chrome limit is 5MB)
- Fix: Strip imageDataUrl before storage, reduce cap to 500 sales

### System Catcher Book Cover (Side Project) ‚úÖ
- Created full wraparound cover for Amazon KDP paperback
- 282 pages, 6√ó9 trim, cream paper
- Back cover: blurb, author photo, bio
- Spine: title + author name
- File: `System_Catcher_Full_Cover_Final.pdf`
- Pricing: $13.99 paperback, $4.99 Kindle

---

## Session 20 Summary (January 31, 2026)

### Major Win: Single Source of Truth ‚úÖ
Photo Upload now uses `/api/extract` backend. Both Photo Upload AND Slab Worthy share the same extraction logic in `comic_extraction.py`.

### Blocked: Barcode Scanning Needs Docker üöß

**Problem:** pyzbar needs libzbar0 system library. Render won't install it.

**Solution:** Docker deployment
```dockerfile
FROM python:3.11-slim
RUN apt-get update && apt-get install -y libzbar0 && rm -rf /var/lib/apt/lists/*
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
CMD ["gunicorn", "wsgi:app", "--timeout", "300", "--bind", "0.0.0.0:10000"]
```

**Why Critical:**
- Can't detect reprints (Spawn #1: $25 reprint vs $300 first print)
- Can't verify variants (Cover A vs B)
- "No better than competition" without this

---

## Next Session Priority

### 1. Docker Setup for Barcode Scanning
1. Create Dockerfile in repo root
2. Change Render Environment to "Docker"
3. Clear cache and deploy
4. Verify pyzbar loads
5. Test barcode extraction with real comic
6. Use barcode data in valuations

### After Barcode Working
- Filter reprints from valuation comps
- Add reprint/variant warnings to UI
- Test with Spawn #1 to verify detection

---

## Quick Reference

### Deployment Commands
```powershell
# Backend (Render) - deploy is REQUIRED
git add .; git commit -m "message"; git push; deploy

# Frontend (Cloudflare) - purge cache
git add .; git commit -m "message"; git push; purge

# Both
git add .; git commit -m "message"; git push; deploy; purge
```

### eBay Collector Testing
```sql
-- Check collected sales
SELECT COUNT(*) FROM ebay_sales;

-- Check R2 image backup
SELECT ebay_item_id, raw_title, r2_image_url 
FROM ebay_sales 
WHERE r2_image_url IS NOT NULL 
LIMIT 5;

-- Stats endpoint
-- https://collectioncalc.onrender.com/api/ebay-sales/stats
```

### Key Documents
- `ROADMAP.md` - Feature roadmap and version history
- `BRAND_GUIDELINES.md` - Voice, terminology, design principles
- `COMPETITORS.md` - Competitor analysis
- `ARCHITECTURE.md` - Technical architecture

---

*Last updated: February 1, 2026 (Session 21)*
*Next priority: Docker deployment for barcode scanning*
