# Claude Working Notes - CollectionCalc Project

## IMPORTANT RULES
1. **Always describe what I plan to build and wait for Mike's approval BEFORE writing any code. Do not build until approved.**
2. **Break large code changes into small chunks** to avoid "thinking longer than usual" failures.
3. **Update this file at checkpoints** (see Checkpoint System below).
4. **Proactively push back and provide input** - Mike wants Claude to flag potential issues, suggest alternatives, and ask "have you considered..." when there are trade-offs. Don't just execute - use knowledge from other projects and patterns.
5. **Follow brand guidelines** - All user-facing text, UI elements, animations, and design decisions should align with BRAND_GUIDELINES.md. Check terminology, tone, and visual principles before implementing.
6. **Verify file integrity before delivering** - Check line count, verify proper closing brackets/braces, and compare to original if editing. Files have been truncated in the past.

## Checkpoint System
Update CLAUDE_NOTES.md when:
- ‚úÖ After any context compacting (conversation got long)
- ‚úÖ After completing a major feature
- ‚úÖ Before ending a session
- ‚úÖ If Mike says "let's checkpoint" or "update notes"

This ensures we can recover quickly if a conversation fails or needs to restart.

## About Mike
- **Name:** Mike (legal name Don, goes by Mike)
- **Role:** Product Manager in high tech, manages people (not hands-on dev)
- **Background:** Former eBay employee (marketing/content supply chain, not engineering)
- **Technical comfort:** Decent SQL skills, uses DBeaver for PostgreSQL queries
- **Strengths:** Product vision, feature prioritization, testing, user feedback, UI/UX decisions
- **Learning style:** Appreciates guidance but wants Claude to recognize when he's mastered something and stop over-explaining
- **Collaboration style:** Wants Claude to push back on decisions (UI, data flow, database, backend) and proactively share knowledge

## What Mike's Comfortable With
- ‚úÖ Render dashboard (deployments, environment variables, redeploys)
- ‚úÖ Git workflow (add, commit, push)
- ‚úÖ PowerShell aliases (`purge`, `deploy`)
- ‚úÖ Testing the app and providing feedback
- ‚úÖ SQL concepts and DBeaver
- ‚úÖ Product decisions and prioritization

## Where They Need More Guidance
- ‚ö†Ô∏è Complex Python debugging - explain error meanings
- ‚ö†Ô∏è Architecture decisions - explain trade-offs

## Project: CollectionCalc / Slab Worthy

### Core Info
- **What it is:** AI-powered comic book valuation and pre-grading assessment tool
- **Stack:** Python/Flask backend, vanilla HTML/JS frontend, PostgreSQL database
- **Hosted on:** Render.com ($7/mo Starter plan - NO cold starts)
- **Live URL:** https://collectioncalc.com
- **Version:** 2.98.0

### Key Product Features
- **Manual Entry** - Type title/issue/grade for valuation
- **Photo Upload** - AI extracts comic info from cover photo
- **Slab Worthy?** - 4-photo grading assessment flow (Patent Pending, filed Jan 27, 2026)
- **Slab Report** - Output of Slab Worthy with grade estimate and recommendation
- **Whatnot Extension** - Browser extension for live stream valuations

### Key Files
**Frontend (Cloudflare Pages):**
- `app.html` - Main frontend
- `styles.css` - Styling
- `js/utils.js` - Shared state, image processing, UI helpers
- `js/auth.js` - Authentication, user menu, collection
- `js/app.js` - eBay, photo upload, valuation, manual entry
- `js/grading.js` - Slab Worthy 4-photo flow, grade report

**Backend (Render):**
- `wsgi.py` - Flask app entry point
- `ebay_valuation.py` - Backend valuation logic
- `comic_extraction.py` - AI photo analysis
- `auth.py` - Authentication
- `admin.py` - Admin panel

### Database Info
- **Host:** Render PostgreSQL
- **Tool:** DBeaver for queries
- **Key table:** `search_cache` (title, issue, grade, estimated_value, fair_value, high_value, created_at)
- **Cache duration:** 48 hours

### Brand Guidelines Summary
Reference BRAND_GUIDELINES.md for full details. Key points:
- **Voice:** Expert, approachable, honest, helpful (not salesy or hyperbolic)
- **Terminology:** Use "assess" or "check" not "grade" (CGC grades, we assess)
- **Animations:** Purposeful and informative, NOT gambling metaphors (no slots, dice, spinning wheels)
- **Loading text:** "Analyzing..." matches existing patterns
- **Patent Pending:** Display on Slab Worthy feature, not on Slab Report output

## Previous Session (January 29, 2026 - Sessions 15-17)

### Session 17 Summary
- ‚úÖ Cache key crash fix (`issue.strip()` on integers)
- ‚úÖ Added search logging to diagnose Spawn #1 issue
- ‚úÖ Identified reprint confusion in valuations

## Current Session (January 30, 2026 - Session 18)

### Major Changes Completed

1. ‚úÖ **Slab Worthy Step 1 uses backend extraction**
   - Single source of truth: both Photo Upload and Slab Worthy use `/api/extract`
   - All extraction fields now available in Slab Worthy (barcode_digits, edition, printing, is_facsimile, etc.)
   - `grading.js` updated to call `/api/extract` for Step 1

2. ‚úÖ **barcode_digits field added to extraction**
   - New field in `comic_extraction.py` prompt
   - Extracts 5-digit UPC add-on code for print/variant identification
   - Includes examples: DC "00111" = issue 1, 1st printing, cover A
   - Works for modern comics; older comics return empty string (correct)

3. ‚úÖ **Deterministic grading with temperature=0**
   - Added `temperature: 0` to `/api/extract` call in `comic_extraction.py`
   - Added `temperature: 0` to `/api/messages` proxy in `wsgi.py`
   - Same image now produces same grade every time

4. ‚úÖ **wsgi.py media_type passthrough**
   - `/api/extract` now accepts and passes `media_type` to extraction function
   - Supports PNG, HEIC, WebP properly

5. ‚úÖ **UI Polish Changes (app.html)**
   - "Upload from Gallery" ‚Üí "Upload" (all 4 places)
   - "üí∞ Should You Grade This?" ‚Üí Slab SVG icon + "Should You Slab It?"
   - Warning message ‚Üí "Grade based on limited photos. Add spine, back, and centerfold for higher confidence."

6. ‚úÖ **Thinking animation added (grading.js)**
   - Cycles through informative messages during valuation
   - Messages: market research, valuation, recommendation phases
   - Spinner + text with fade transitions
   - **BUG:** Not appearing in UI - needs debugging

### Files Modified This Session
- `comic_extraction.py` - barcode_digits, temperature=0
- `wsgi.py` - temperature=0 on /api/messages, media_type passthrough
- `grading.js` - Step 1 uses /api/extract, thinking animation
- `app.html` - UI text changes

### Known Bugs to Fix
- üêõ **Thinking animation not showing** - Code added but not appearing in Slab Worthy Step 5
- üêõ **Photo Upload missing thinking animation** - Needs same treatment as Slab Worthy
- üêõ **Hide "Take Photo" on desktop** - Only show "Upload" button on non-mobile

### Pending Work

#### High Priority
- [ ] Debug thinking animation not appearing
- [ ] Add thinking animation to Photo Upload (app.js)
- [ ] Barcode decoder logic (interpret 5-digit codes by publisher)
- [ ] Test barcode extraction with modern comic (Absolute Batman with better image)

#### Medium Priority
- [ ] Prompt Management Admin Page - view/edit all prompts in one place
- [ ] True Meta-Optimization for prompts (Level 4 - use Claude to improve prompts)
- [ ] Key issue sanity check database (floor prices)
- [ ] Fix Whatnot extension (null issue polling)

#### Low Priority
- [ ] Hide "Take Photo" button on desktop
- [ ] Pricing model decisions
- [ ] FAQ content

## Useful Info

### Image Quality for Barcode Reading
- Facebook Messenger: Heavy compression, send as file attachment instead
- WhatsApp: Tap "HD" button when sending, or send as "Document"
- Email: Usually full quality (best option)
- iMessage: Good quality

### Temperature Setting
- `temperature: 0` = Deterministic (same input = same output)
- `temperature: 0.5-0.7` = Balanced
- `temperature: 1.0` = Creative
- For grading: ALWAYS use 0

## Deployment Commands
```powershell
# Deploy and clear cache
git add .; git commit -m "message"; git push; deploy; purge

# Just clear Cloudflare cache
purge
```

---
*Last updated: January 30, 2026 (Session 18)*
