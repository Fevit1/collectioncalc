# Claude Working Notes - CollectionCalc Project

## IMPORTANT RULES
1. **Always describe what I plan to build and wait for Mike's approval BEFORE writing any code. Do not build until approved.**
2. **Break large code changes into small chunks** to avoid "thinking longer than usual" failures.
3. **Update this file at checkpoints** (see Checkpoint System below).
4. **Proactively push back and provide input** - Mike wants Claude to flag potential issues, suggest alternatives, and ask "have you considered..." when there are trade-offs. Don't just execute - use knowledge from other projects and patterns.
5. **Follow brand guidelines** - All user-facing text, UI elements, animations, and design decisions should align with BRAND_GUIDELINES.md. Check terminology, tone, and visual principles before implementing.
6. **Verify file integrity before delivering** - Check line count, verify proper closing brackets/braces, and compare to original if editing. Files have been truncated in the past.
7. **Render auto-deploy is DISABLED** - Always include `deploy` command after `git push` for backend changes.
8. **Don't accept limitations** - When Claude or existing solutions hit capability limits, proactively research and suggest alternative tools/libraries/APIs. Don't settle unless the effort clearly isn't worth the payoff.
9. **Reference COMPETITORS.md** - Competitor analysis is maintained separately. Check it when discussing market positioning or feature priorities.

## Checkpoint System
Update CLAUDE_NOTES.md when:
- ‚úÖ After any context compacting (conversation got long)
- ‚úÖ After completing a major feature
- ‚úÖ Before ending a session
- ‚úÖ If Mike says "let's checkpoint" or "update notes"

This ensures we can recover quickly if a conversation fails or needs to restart.

## About Mike
- **Name:** Mike (legal name Don, goes by Mike)
- **Role:** Product Manager in high tech, manages people (not hands-on dev)
- **Background:** Former eBay employee (marketing/content supply chain, not engineering)
- **Technical comfort:** Decent SQL skills, uses DBeaver for PostgreSQL queries
- **Strengths:** Product vision, feature prioritization, testing, user feedback, UI/UX decisions
- **Learning style:** Appreciates guidance but wants Claude to recognize when he's mastered something and stop over-explaining
- **Collaboration style:** Wants Claude to push back on decisions (UI, data flow, database, backend) and proactively share knowledge

## What Mike's Comfortable With
- ‚úÖ Render dashboard (deployments, environment variables, redeploys)
- ‚úÖ Git workflow (add, commit, push)
- ‚úÖ PowerShell aliases (`purge`, `deploy`)
- ‚úÖ Testing the app and providing feedback
- ‚úÖ SQL concepts and DBeaver
- ‚úÖ Product decisions and prioritization

## Where They Need More Guidance
- ‚ö†Ô∏è Complex Python debugging - explain error meanings
- ‚ö†Ô∏è Architecture decisions - explain trade-offs

## Project: CollectionCalc / Slab Worthy

### Core Info
- **What it is:** AI-powered comic book valuation and pre-grading assessment tool
- **Stack:** Python/Flask backend, vanilla HTML/JS frontend, PostgreSQL database
- **Hosted on:** Render.com ($7/mo Starter plan - NO cold starts)
- **Live URL:** https://collectioncalc.com
- **Version:** 2.98.0

### Key Product Features
- **Manual Entry** - Type title/issue/grade for valuation
- **Photo Upload** - AI extracts comic info from cover photo
- **Slab Worthy?** - 4-photo grading assessment flow (Patent Pending, filed Jan 27, 2026)
- **Slab Report** - Output of Slab Worthy with grade estimate and recommendation
- **Whatnot Extension** - Browser extension for live stream valuations

### Key Files
**Frontend (Cloudflare Pages):**
- `app.html` - Main frontend
- `styles.css` - Styling
- `js/utils.js` - Shared state, image processing, UI helpers
- `js/auth.js` - Authentication, user menu, collection
- `js/app.js` - eBay, photo upload, valuation, manual entry
- `js/grading.js` - Slab Worthy 4-photo flow, grade report

**Backend (Render):**
- `wsgi.py` - Flask app entry point
- `ebay_valuation.py` - Backend valuation logic
- `comic_extraction.py` - AI photo analysis
- `auth.py` - Authentication
- `admin.py` - Admin panel

### Database Info
- **Host:** Render PostgreSQL
- **Tool:** DBeaver for queries
- **Key table:** `search_cache` (title, issue, grade, estimated_value, fair_value, high_value, created_at)
- **Cache duration:** 48 hours

### Brand Guidelines Summary
Reference BRAND_GUIDELINES.md for full details. Key points:
- **Voice:** Expert, approachable, honest, helpful (not salesy or hyperbolic)
- **Terminology:** Use "assess" or "check" not "grade" (CGC grades, we assess)
- **Animations:** Purposeful and informative, NOT gambling metaphors (no slots, dice, spinning wheels)
- **Loading text:** "Analyzing..." matches existing patterns
- **Patent Pending:** Display on Slab Worthy feature, not on Slab Report output

## Previous Sessions (January 30-31, 2026 - Sessions 18-19)

### Session 19 Summary (Jan 31)
- ‚úÖ 20-tier slab premium model (grading.js) - premiums from 4x at $10 to 1.12x at $10k+
- ‚úÖ Exponential decay recency (ebay_valuation.py) - 30-day half-life
- ‚úÖ Whatnot extension v2.41.1 - fixed null polling, interval cleanup, visibility pause
- ‚úÖ Server-side garbage filter (wsgi.py) - blocks "$30", "91 Available", issue=null

### Session 18 Summary (Jan 30)
- ‚úÖ Slab Worthy Step 1 uses backend extraction
- ‚úÖ barcode_digits field added to extraction
- ‚úÖ Deterministic grading with temperature=0
- ‚úÖ UI polish (Upload button text, Slab It branding)
- ‚úÖ Thinking animation added (now working)

## Current Session (January 31, 2026 - Session 20)

### Changes Completed
1. ‚úÖ **Barcode decoder function** - `decode_barcode()` in comic_extraction.py
   - Decodes 5-digit UPC supplement: issue, cover_letter (A/B/C), printing
   - Returns is_variant, is_reprint flags
   - Auto-included as `barcode_decoded` in extraction response

2. ‚úÖ **pyzbar barcode scanning** - Middleware solution for reliable barcode reading
   - Claude Vision struggles with tiny barcode digits
   - pyzbar scans image before Claude, extracts barcode reliably
   - Falls back gracefully if not found
   - Requires: `pyzbar`, `Pillow` in requirements.txt
   - May require `Aptfile` with `libzbar0` for Render

3. ‚úÖ **Extraction prompt improvements**
   - Added `writer` and `artist` fields
   - Made `barcode_digits` required with JSON template
   - Still debugging - Render serving old prompt (2985 tokens vs expected 3200+)

4. ‚úÖ **COMPETITORS.md** - Full competitor analysis document created
   - 6 competitors analyzed: CovrPrice, GoCollect, Key Collector, CLZ, ComicMint AI, Tabi
   - Feature comparison matrix
   - Threat levels and our differentiators

### Known Issues
- üêõ **Render not picking up new prompt** - Clear cache & rebuild in progress
- üêõ **Hide "Take Photo" on desktop** - Only show "Upload" button in Slab Worthy on non-mobile

### Pending Work

#### High Priority
- [ ] Verify pyzbar working on Render (may need Aptfile with libzbar0)
- [ ] Test barcode extraction once Render updated
- [ ] Reprint filtering for valuations (Spawn #1 problem)

#### Medium Priority
- [ ] Prompt Management Admin Page - view/edit all prompts in one place
- [ ] Key issue sanity check database (floor prices)

#### Low Priority
- [ ] Pricing model decisions
- [ ] FAQ content

### Files Modified This Session
- `comic_extraction.py` - pyzbar scanning, decode_barcode(), writer/artist fields, required JSON template
- `COMPETITORS.md` - Full competitor analysis document

## Useful Info

### Image Quality for Barcode Reading
- Facebook Messenger: Heavy compression, send as file attachment instead
- WhatsApp: Tap "HD" button when sending, or send as "Document"
- Email: Usually full quality (best option)
- iMessage: Good quality

### Temperature Setting
- `temperature: 0` = Deterministic (same input = same output)
- `temperature: 0.5-0.7` = Balanced
- `temperature: 1.0` = Creative
- For grading: ALWAYS use 0

## Deployment Commands
```powershell
# Backend changes (Render) - deploy is REQUIRED (auto-deploy disabled)
git add .; git commit -m "message"; git push; deploy

# Frontend changes (Cloudflare) - purge cache
git add .; git commit -m "message"; git push; purge

# Both
git add .; git commit -m "message"; git push; deploy; purge
```

## Key Documents
- `COMPETITORS.md` - Competitor analysis (CovrPrice, GoCollect, Key Collector, CLZ, ComicMint AI, Tabi)
- `BRAND_GUIDELINES.md` - Voice, terminology, design principles
- `ROADMAP.md` - Feature roadmap and version history
- `ARCHITECTURE.md` - Technical architecture

---
*Last updated: January 31, 2026 (Session 20)*
