# Claude Working Notes - CollectionCalc Project

## IMPORTANT RULES
1. **Always describe what I plan to build and wait for Mike's approval BEFORE writing any code. Do not build until approved.**
2. **Break large code changes into small chunks** to avoid "thinking longer than usual" failures.
3. **Update this file at checkpoints** (see Checkpoint System below).
4. **Proactively push back and provide input** - Mike wants Claude to flag potential issues, suggest alternatives, and ask "have you considered..." when there are trade-offs. Don't just execute - use knowledge from other projects and patterns.
5. **Follow brand guidelines** - All user-facing text, UI elements, animations, and design decisions should align with BRAND_GUIDELINES.md. Check terminology, tone, and visual principles before implementing.
6. **Verify file integrity before delivering** - Check line count, verify proper closing brackets/braces, and compare to original if editing. Files have been truncated in the past.

## Checkpoint System
Update CLAUDE_NOTES.md when:
- ‚úÖ After any context compacting (conversation got long)
- ‚úÖ After completing a major feature
- ‚úÖ Before ending a session
- ‚úÖ If Mike says "let's checkpoint" or "update notes"

This ensures we can recover quickly if a conversation fails or needs to restart.

## About Mike
- **Name:** Mike (legal name Don, goes by Mike)
- **Role:** Product Manager in high tech, manages people (not hands-on dev)
- **Background:** Former eBay employee (marketing/content supply chain, not engineering)
- **Technical comfort:** Decent SQL skills, uses DBeaver for PostgreSQL queries
- **Strengths:** Product vision, feature prioritization, testing, user feedback, UI/UX decisions
- **Learning style:** Appreciates guidance but wants Claude to recognize when he's mastered something and stop over-explaining
- **Collaboration style:** Wants Claude to push back on decisions (UI, data flow, database, backend) and proactively share knowledge

## What Mike's Comfortable With
- ‚úÖ Render dashboard (deployments, environment variables, redeploys)
- ‚úÖ Git workflow (add, commit, push)
- ‚úÖ PowerShell aliases (`purge`, `deploy`)
- ‚úÖ Testing the app and providing feedback
- ‚úÖ SQL concepts and DBeaver
- ‚úÖ Product decisions and prioritization

## Where They Need More Guidance
- ‚ö†Ô∏è Complex Python debugging - explain error meanings
- ‚ö†Ô∏è Architecture decisions - explain trade-offs

## Project: CollectionCalc / Slab Worthy

### Core Info
- **What it is:** AI-powered comic book valuation and pre-grading assessment tool
- **Stack:** Python/Flask backend, vanilla HTML/JS frontend, PostgreSQL database
- **Hosted on:** Render.com ($7/mo Starter plan - NO cold starts)
- **Live URL:** https://collectioncalc.com
- **Version:** 2.97.1

### Key Product Features
- **Manual Entry** - Type title/issue/grade for valuation
- **Photo Upload** - AI extracts comic info from cover photo
- **Slab Worthy?** - 4-photo grading assessment flow (Patent Pending, filed Jan 27, 2026)
- **Slab Report** - Output of Slab Worthy with grade estimate and recommendation
- **Whatnot Extension** - Browser extension for live stream valuations

### Key Files
**Frontend (Cloudflare Pages):**
- `app.html` - Main frontend
- `styles.css` - Styling
- `js/utils.js` - Shared state, image processing, UI helpers
- `js/auth.js` - Authentication, user menu, collection
- `js/app.js` - eBay, photo upload, valuation, manual entry
- `js/grading.js` - Slab Worthy 4-photo flow, grade report

**Backend (Render):**
- `wsgi.py` - Flask app entry point
- `ebay_valuation.py` - Backend valuation logic
- `comic_extraction.py` - AI photo analysis
- `auth.py` - Authentication
- `admin.py` - Admin panel

### Database Info
- **Host:** Render PostgreSQL
- **Tool:** DBeaver for queries
- **Key table:** `search_cache` (title, issue, grade, estimated_value, fair_value, high_value, created_at)
- **Cache duration:** 48 hours

### Brand Guidelines Summary
Reference BRAND_GUIDELINES.md for full details. Key points:
- **Voice:** Expert, approachable, honest, helpful (not salesy or hyperbolic)
- **Terminology:** Use "assess" or "check" not "grade" (CGC grades, we assess)
- **Animations:** Purposeful and informative, NOT gambling metaphors (no slots, dice, spinning wheels)
- **Loading text:** "Analyzing..." matches existing patterns
- **Patent Pending:** Display on Slab Worthy feature, not on Slab Report output

## Previous Session (January 29, 2026 - Sessions 15-16)

### Bugs Fixed
1. ‚úÖ **Login persistence** - Token wasn't loading from localStorage on page init
2. ‚úÖ **Mobile extraction "bug"** - Was actually auth issue; works when logged in
3. ‚úÖ **Rotation detection false positive** - Updated prompt to check TEXT only, not artistic elements
4. ‚úÖ **Server slowdown identified** - Whatnot extension polling with `issue=null`

### Features Added
1. ‚úÖ **Upload from Gallery** - Slab Worthy now has two buttons: "Take Photo" and "Upload from Gallery"
2. ‚úÖ **Auto-rotation for all steps** - Steps 2-4 now have `is_upside_down` check in prompts

## Current Session (January 30, 2026 - Session 17)

### Bugs Fixed Today
1. ‚úÖ **Cache key crash** - `issue.strip()` failed when issue was integer (e.g., `1` instead of `"1"`). Fixed by wrapping with `str(issue).strip()` in 6 places in ebay_valuation.py.
2. ‚úÖ **Valuations returning "could not retrieve"** - Was caused by the cache crash above. After deleting bad cache entries and deploying fix, valuations work again.

### Diagnostic Work
1. ‚úÖ **Added search logging** - ebay_valuation.py now logs:
   - `[SEARCH] Query: {title} #{issue} ({grade}) - signed={bool}`
   - `[SEARCH RESULTS] Found X sales, Y BIN listings` with first 5 sale details
   - This will help diagnose why Spawn #1 returned $23 instead of $300+

### Issue Identified (Not Yet Fixed)
- **Spawn #1 returning ~$25 instead of $300-400** - Likely matching reprints instead of first prints. The search query doesn't distinguish print editions. Better cover reading is the real fix (reprints typically identify themselves on cover). Could also add "key issue" sanity check database.

### UI Changes Noted (Not Yet Implemented)
1. "Upload from Gallery" ‚Üí "Upload" (shorter)
2. Money bag icon ‚Üí Slab SVG icon next to "Should you slab it?"
3. "Should you grade this" ‚Üí "Should you slab it?"
4. Add calculating animation/status for valuation step

### Other Notes
- Mike's book "System Catcher" is live on Amazon since Jan 27. Cover image still not showing after 48hrs - should appear by Jan 30 or contact KDP support.

## Known Issues (Bug List)
- üêõ **Spawn #1 / reprint confusion** - Search matches reprints, returns low values for keys
- üêõ **Auto-rotation steps 2-4** - Added code but not working; needs debugging
- üêõ **Whatnot extension** - Polling with null issue, doesn't stop when tab closed
- üêõ **Debug alerts still in code** - Remove once stable
- üêõ **Slab Worthy UI polish needed** - Camera/Gallery buttons need refinement

## Pending Work

### High Priority
- [ ] Investigate Spawn #1 reprint issue using new logging
- [ ] Better cover reading to detect print edition (1st print vs reprint)
- [ ] UI changes: "Should you slab it?", slab icon, "Upload" button text
- [ ] Calculating animation for valuation step
- [ ] Fix auto-rotation for steps 2-4
- [ ] Remove debug alerts from grading.js

### Medium Priority
- [ ] Key issue sanity check database (floor prices to catch bad values)
- [ ] Fix Whatnot extension (null issue polling, stop on tab close)
- [ ] High-value comic testing for ROI validation
- [ ] FAQ content (pressing, newsstand vs direct, valuation methodology, grade scale, CGC costs)
- [ ] Mobile visual/layout review

### Low Priority
- [ ] Pricing model decisions
- [ ] Business model canvas
- [ ] Competitive analysis (CovrPrice, GoCollect, Key Collector, CLZ, ComicMint AI)

## Useful SQL Queries

```sql
-- Check for bad cached values
SELECT title, issue, estimated_value, fair_value FROM search_cache 
WHERE estimated_value = 0 OR fair_value = 0;

-- Recent cache entries
SELECT title, issue, grade, estimated_value, created_at 
FROM search_cache ORDER BY created_at DESC LIMIT 20;

-- Delete specific comic from cache (use when investigating bad values)
DELETE FROM search_cache WHERE title ILIKE '%spawn%' AND issue = '1';

-- Find all cached entries for a title
SELECT * FROM search_cache WHERE title ILIKE '%spawn%';
```

## Deployment Commands
```powershell
# Deploy and clear cache
git add .; git commit -m "message"; git push; purge

# Just clear Cloudflare cache
purge
```

---
*Last updated: January 30, 2026 (Session 17)*
