# Claude Working Notes - CollectionCalc Project

## Executive Summary

**Purpose:** This document helps Claude quickly get up to speed when starting a new session with Mike on the CollectionCalc project.

**The Project:** CollectionCalc is an AI-powered comic book valuation tool. The flagship feature "Slab Worthy?" uses patent-pending multi-angle photography to assess whether comics are worth professional grading.

**The Human:** Mike is a Product Manager (not a developer). He's comfortable with Git, Render deployments, and SQL queries, but needs guidance on complex debugging and architecture decisions. He wants Claude to push back and share knowledge proactively.

**Current State (v2.99.0):**
- Core features working: Manual Entry, Photo Upload, Slab Worthy
- Single source of truth achieved for all extraction (comic_extraction.py)
- Writer/Artist extraction working
- Barcode infrastructure ready but blocked on Docker deployment
- eBay Collector extension ready to test
- Whatnot Valuator extension v2.41.2 deployed (storage quota fix)

**Critical Priority:** Barcode scanning via Docker. Without it, we can't detect reprints (Spawn #1: $25 reprint vs $300 first print). This is the #1 differentiator vs competition.

**Key Rules:**
1. Get approval before coding
2. Render auto-deploy is OFF - always run `deploy` command
3. Don't accept limitations - research alternatives
4. Update this doc at session end

---

## Important Rules

1. **Always describe what I plan to build and wait for Mike's approval BEFORE writing any code.**
2. **Break large code changes into small chunks** to avoid "thinking longer than usual" failures.
3. **Update this file at checkpoints** - after compacting, features, or session end.
4. **Proactively push back** - flag issues, suggest alternatives, share knowledge from other projects.
5. **Follow brand guidelines** - check BRAND_GUIDELINES.md for voice, terminology, design.
6. **Verify file integrity** - check line counts, closing brackets. Files have been truncated before.
7. **Render auto-deploy is DISABLED** - Always include `deploy` command after `git push`.
8. **Don't accept limitations** - research alternative tools/libraries/APIs. Don't settle.
9. **Reference COMPETITORS.md** - check it when discussing market positioning.

---

## About Mike

- **Role:** Product Manager in high tech (manages people, not hands-on dev)
- **Background:** Former eBay (marketing/content supply chain, not engineering)
- **Technical comfort:** Decent SQL skills, uses DBeaver for PostgreSQL queries

**Comfortable with:**
- ‚úÖ Render dashboard (deployments, env vars, redeploys)
- ‚úÖ Git workflow (add, commit, push)
- ‚úÖ PowerShell aliases (`purge`, `deploy`)
- ‚úÖ Testing and providing feedback
- ‚úÖ Product decisions and prioritization

**Needs guidance on:**
- ‚ö†Ô∏è Complex Python debugging - explain error meanings
- ‚ö†Ô∏è Architecture decisions - explain trade-offs

**Collaboration style:** Wants Claude to push back on decisions and proactively share knowledge. Appreciates when Claude recognizes he's mastered something and stops over-explaining.

---

## Project Overview

### CollectionCalc / Slab Worthy
- **What:** AI-powered comic book valuation and pre-grading assessment
- **Stack:** Python/Flask backend, vanilla HTML/JS frontend, PostgreSQL
- **Hosting:** Render.com ($7/mo Starter), Cloudflare Pages
- **URL:** https://collectioncalc.com
- **Version:** 2.99.0

### Key Features
| Feature | Description |
|---------|-------------|
| Manual Entry | Type title/issue/grade for valuation |
| Photo Upload | AI extracts comic info from cover photo |
| Slab Worthy? | 4-photo grading assessment (Patent Pending) |
| Slab Report | Grade estimate + economic recommendation |
| Whatnot Extension | Browser extension for live stream valuations |
| eBay Collector | Passive data collection from eBay sold listings |

### Key Files
**Frontend (Cloudflare Pages):**
- `app.html` - Main frontend
- `styles.css` - Styling  
- `js/utils.js` - Shared state, image processing
- `js/auth.js` - Authentication, user menu
- `js/app.js` - Photo upload, valuation, manual entry
- `js/grading.js` - Slab Worthy 4-photo flow

**Backend (Render):**
- `wsgi.py` - Flask app entry point
- `comic_extraction.py` - AI photo analysis (SINGLE SOURCE OF TRUTH)
- `ebay_valuation.py` - Valuation logic
- `auth.py` - Authentication
- `admin.py` - Admin panel

---

## Session 21 Summary (February 1, 2026)

### eBay Collector Extension - API Fixed ‚úÖ
Fixed wsgi.py endpoints for eBay sales data collection:
- Added `import psycopg2` inside each function (matches existing pattern)
- Added `database_url = os.environ.get('DATABASE_URL')`
- Database ready: `ebay_sales` table + `comic_fmv` view created
- **Status:** Ready to test - install extension, browse eBay sold listings

**Endpoints:**
- `POST /api/ebay-sales/batch` - Batch insert sales from extension
- `GET /api/ebay-sales/stats` - Get collection statistics

### Whatnot Valuator Extension - Storage Fix ‚úÖ
Fixed Chrome local storage quota exceeded error (v2.41.2):
- **Root cause:** Storing full base64 images (5000 sales √ó ~100KB = 500MB, Chrome limit: 5MB)
- **Fix:** Strip `imageDataUrl` and `frameData` before storage (images already in R2)
- Reduced cap: 5000 ‚Üí 500 sales
- Added `compactStorage()` function to clean existing bloated data
- **Status:** Deployed and working

### wsgi.py - Silenced eBay Deletion Notifications ‚úÖ
Removed verbose logging for `MARKETPLACE_ACCOUNT_DELETION` events - these are eBay users who never used our app.

### System Catcher Book Cover (Side Project) ‚úÖ
Created full wraparound cover for Amazon KDP paperback:
- 282 pages, 6√ó9 trim, cream paper
- Back cover: blurb, author photo, bio
- Spine: title + author name in orange
- Pricing: $13.99 paperback, $4.99 Kindle
- File: `System_Catcher_Full_Cover_Final.pdf`

### Not Started This Session
- Docker deployment for barcode scanning (still #1 priority)

### Files Modified This Session
- `wsgi.py` - eBay sales endpoints fixed, deletion notifications silenced

---

## Session 20 Summary (January 31, 2026)

### Major Win: Single Source of Truth ‚úÖ
Photo Upload now uses `/api/extract` backend. Both Photo Upload AND Slab Worthy share the same extraction logic in `comic_extraction.py`.

### Completed
- ‚úÖ Photo Upload migrated to backend extraction
- ‚úÖ New schema: writer, artist, barcode_digits, signatures[], is_facsimile
- ‚úÖ Writer/Artist extraction working (tested: Scott Snyder / Nick Dragotta)
- ‚úÖ UI: "Variant" field ‚Üí "Artist" field
- ‚úÖ Barcode decode_barcode() function ready
- ‚úÖ Signature analysis commented out for future
- ‚úÖ Debug endpoint: /api/debug/prompt-check
- ‚úÖ pyzbar + Pillow in requirements.txt

### Blocked: Barcode Scanning Needs Docker üöß

**Problem:** pyzbar needs libzbar0 system library. Render won't install it.
- Aptfile ignored when custom build command exists
- apt-get fails (read-only filesystem)

**Solution:** Docker deployment
```dockerfile
FROM python:3.11-slim
RUN apt-get update && apt-get install -y libzbar0 && rm -rf /var/lib/apt/lists/*
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
CMD ["gunicorn", "wsgi:app", "--timeout", "300", "--bind", "0.0.0.0:10000"]
```

**Why Critical:**
- Can't detect reprints (Spawn #1: $25 reprint vs $300 first print)
- Can't verify variants (Cover A vs B)
- "No better than competition" without this

---

## Next Session Priority

### 1. Test eBay Collector Extension
1. Load extension in Chrome (chrome://extensions ‚Üí Load unpacked)
2. Verify stats endpoint: https://collectioncalc.onrender.com/api/ebay-sales/stats
3. Browse eBay sold listings, watch for green toast
4. Check data in DBeaver: `SELECT * FROM ebay_sales LIMIT 10;`

### 2. Docker Setup for Barcode Scanning
1. Create Dockerfile in repo root
2. Change Render Environment to "Docker"
3. Clear cache and deploy
4. Verify pyzbar loads (check logs for "not available" message)
5. Test barcode extraction with real comic
6. Use barcode data in valuations

### After Barcode Working
- Filter reprints from valuation comps
- Add reprint/variant warnings to UI
- Test with Spawn #1 to verify detection

---

## Quick Reference

### Deployment Commands
```powershell
# Backend (Render) - deploy is REQUIRED
git add .; git commit -m "message"; git push; deploy

# Frontend (Cloudflare) - purge cache
git add .; git commit -m "message"; git push; purge

# Both
git add .; git commit -m "message"; git push; deploy; purge
```

### Render Gotchas
- Custom Build Command overrides Aptfile detection
- "Clear build cache & deploy" needed for build changes
- Check `/api/debug/prompt-check` to verify deployed prompt

### Key Documents
- `ROADMAP.md` - Feature roadmap and version history
- `BRAND_GUIDELINES.md` - Voice, terminology, design principles
- `COMPETITORS.md` - Competitor analysis
- `ARCHITECTURE.md` - Technical architecture

---

*Last updated: February 1, 2026 (Session 21)*
*Next priority: Test eBay extension, then Docker deployment for barcode scanning*
