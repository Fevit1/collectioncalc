<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CollectionCalc - AI-Powered Collectible Valuation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --brand-indigo: #4f46e5;
            --brand-purple: #7c3aed;
            --brand-cyan: #06b6d4;
            --brand-gradient: linear-gradient(135deg, #4f46e5, #7c3aed);
            --value-gradient: linear-gradient(135deg, #06b6d4, #7c3aed);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --status-success: #10b981;
            --status-warning: #f59e0b;
            --status-error: #ef4444;
            --border-default: #334155;
            --border-accent: #4f46e5;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
        }
        .container { max-width: 750px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: var(--brand-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle { color: var(--text-secondary); font-size: 1.1rem; }
        
        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--bg-primary);
            padding: 6px;
            border-radius: 12px;
            border: 1px solid var(--border-default);
        }
        .mode-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .mode-btn.active {
            background: var(--brand-gradient);
            color: var(--text-primary);
        }
        .mode-btn:not(.active) {
            background: transparent;
            color: var(--text-muted);
        }
        .mode-btn:not(.active):hover {
            color: var(--text-secondary);
            background: rgba(79, 70, 229, 0.1);
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid var(--border-accent);
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-default);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--brand-indigo);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        input::placeholder, textarea::placeholder { color: var(--text-muted); }
        select option { background: var(--bg-primary); color: var(--text-primary); }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        
        button {
            width: 100%;
            padding: 14px;
            background: var(--brand-gradient);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.4);
        }
        button:disabled { 
            opacity: 0.4; 
            cursor: not-allowed; 
            transform: none; 
            background: var(--border-default);
            box-shadow: none;
        }
        
        .btn-secondary {
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
        }
        .btn-secondary:hover {
            border-color: var(--brand-indigo);
            box-shadow: none;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
            width: auto;
        }
        
        .upload-area {
            border: 2px dashed var(--border-default);
            border-radius: 12px;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: var(--brand-indigo);
            background: rgba(79, 70, 229, 0.05);
        }
        .upload-area.dragover {
            border-color: var(--brand-cyan);
            background: rgba(6, 182, 212, 0.1);
        }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        .upload-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .upload-subtitle { font-size: 0.9rem; color: var(--text-muted); }
        .upload-input { display: none; }
        
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .checkbox-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--brand-indigo);
        }
        .checkbox-row label {
            margin: 0;
            font-weight: 500;
            cursor: pointer;
        }
        
        /* Item cards for bulk */
        .item-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .item-card.has-value {
            border-color: var(--status-success);
        }
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-default);
        }
        .item-number {
            background: var(--brand-gradient);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .item-title {
            flex: 1;
            margin-left: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .item-value {
            font-weight: 700;
            font-size: 1.2rem;
            background: var(--value-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .item-value-range {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .value-fair {
            font-weight: 700;
            font-size: 1.2rem;
            background: var(--value-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .value-range-small {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }
        /* Price tier boxes */
        .price-tiers {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }
        .price-tier {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--surface-color);
        }
        .price-tier:hover {
            border-color: var(--primary-color);
        }
        .price-tier.selected {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }
        .price-tier-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .price-tier-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 2px;
        }
        .price-tier.selected .price-tier-value {
            background: var(--value-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .price-tier-hint {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 10px;
        }
        .sort-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        .sort-controls label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .sort-controls select {
            padding: 6px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
        }
        .sort-controls select:focus {
            outline: none;
            border-color: var(--brand-indigo);
        }
        .item-card .list-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .item-card .list-btn:hover:not(:disabled) {
            opacity: 0.9;
        }
        .item-card .list-btn:disabled {
            background: var(--surface-color);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        .item-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            font-size: 1.2rem;
            width: auto;
        }
        .item-delete:hover {
            color: var(--status-error);
            transform: none;
            box-shadow: none;
        }
        .item-refresh {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            font-size: 1rem;
            width: auto;
            margin-left: 10px;
        }
        .item-refresh:hover {
            color: var(--brand-cyan);
            transform: none;
            box-shadow: none;
        }
        .item-details-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            font-size: 0.85rem;
            width: auto;
            margin-left: 5px;
        }
        .item-details-btn:hover {
            color: var(--brand-cyan);
            transform: none;
            box-shadow: none;
        }
        .sales-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-default);
        }
        .sales-details.show {
            display: block;
        }
        .sales-details h5 {
            color: var(--brand-cyan);
            font-size: 0.85rem;
            margin-bottom: 10px;
        }
        .sale-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        .sale-price {
            font-weight: 600;
            color: var(--brand-cyan);
        }
        .sale-meta {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        .sale-weight {
            background: var(--brand-indigo);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        .item-fields {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
        }
        .item-fields input, .item-fields select {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        .item-fields label {
            font-size: 0.75rem;
            margin-bottom: 4px;
        }
        
        /* Progress bar */
        .progress-container {
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--brand-gradient);
            transition: width 0.3s;
        }
        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Results */
        .result { margin-top: 30px; display: none; }
        .result.show { display: block; }
        .result-card {
            background: var(--bg-primary);
            border: 1px solid var(--brand-indigo);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        .result-card.error { border-color: var(--status-error); }
        .result-label { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px; }
        .price {
            font-size: 3rem;
            font-weight: 700;
            background: var(--value-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 10px 0;
        }
        /* Three-tier pricing display */
        .price-tiers {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .tier {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 20px;
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 110px;
            transition: transform 0.2s, border-color 0.2s;
        }
        .tier:hover {
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.2);
        }
        .tier-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        .tier-price {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 5px 0;
        }
        .tier-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .tier.quick-sale .tier-price { color: #22c55e; }
        .tier.fair-value {
            border-color: var(--brand-cyan);
            background: rgba(6, 182, 212, 0.1);
        }
        .tier.fair-value .tier-price { 
            background: var(--value-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .tier.high-end .tier-price { color: #f59e0b; }
        .result-card.error .price {
            background: none;
            -webkit-text-fill-color: var(--status-error);
            color: var(--status-error);
            font-size: 1.2rem;
        }
        .confidence { margin-bottom: 15px; font-weight: 500; }
        .confidence.high { color: var(--status-success); }
        .confidence.medium-high { color: var(--brand-cyan); }
        .confidence.medium { color: var(--status-warning); }
        .confidence.low { color: #f97316; }
        .confidence.very-low { color: var(--status-error); }
        .source-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            background: var(--brand-gradient);
            color: var(--text-primary);
            margin-top: 10px;
        }
        .steps {
            text-align: left;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .steps h4 { color: var(--brand-cyan); margin-bottom: 10px; font-size: 0.9rem; font-weight: 600; }
        .steps p { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; }
        .ebay-info {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
        }
        .ebay-info h4 { color: var(--brand-cyan); margin-bottom: 8px; font-size: 0.9rem; }
        .ebay-info p { color: var(--text-secondary); font-size: 0.85rem; margin: 4px 0; }
        
        /* Details toggle button */
        .details-toggle {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-secondary);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            margin: 15px 0;
        }
        .details-toggle:hover {
            border-color: var(--brand-cyan);
            color: var(--brand-cyan);
        }
        .details-toggle.active {
            border-color: var(--brand-purple);
            color: var(--brand-purple);
        }
        .details-section {
            display: none;
            text-align: left;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        .details-section.show {
            display: block;
        }
        .details-section h4 { 
            color: var(--brand-cyan); 
            margin-bottom: 10px; 
            font-size: 0.9rem; 
            font-weight: 600; 
        }
        .details-section p { 
            color: var(--text-secondary); 
            font-size: 0.85rem; 
            line-height: 1.5; 
            margin: 8px 0;
        }
        .details-section .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .details-section .stat-label {
            color: var(--text-muted);
        }
        .details-section .stat-value {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        /* eBay integration styles */
        .ebay-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .ebay-connect-btn {
            background: linear-gradient(135deg, #e53238, #f5af02);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .ebay-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(229, 50, 56, 0.3);
        }
        .ebay-connected {
            color: var(--status-success);
            font-size: 0.85rem;
            margin-bottom: 10px;
        }
        .list-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .list-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .list-btn:hover {
            border-color: #e53238;
            color: #e53238;
            background: rgba(229, 50, 56, 0.1);
        }
        .list-btn.listing {
            opacity: 0.7;
            cursor: wait;
        }
        .ebay-logo {
            width: 16px;
            height: 16px;
        }
        
        /* Listing Preview Modal */
        .listing-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .listing-modal-overlay.show {
            display: flex;
        }
        .listing-modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-default);
        }
        .listing-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .listing-modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.2rem;
        }
        .listing-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .listing-modal-close:hover {
            color: var(--text-primary);
        }
        .listing-modal-body {
            padding: 20px;
        }
        .listing-preview-row {
            margin-bottom: 15px;
        }
        .listing-preview-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .listing-preview-value {
            color: var(--text-primary);
            font-size: 1rem;
        }
        .listing-preview-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #22c55e;
        }
        .listing-preview-image {
            width: 100%;
            max-width: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-default);
            margin: 10px 0;
        }
        .listing-description-edit {
            width: 100%;
            min-height: 200px;
            background: var(--bg-primary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }
        .listing-description-edit:focus {
            outline: none;
            border-color: var(--brand-purple);
        }
        .listing-validation {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .listing-validation.valid {
            background: rgba(16, 185, 129, 0.1);
            color: var(--status-success);
        }
        .listing-validation.invalid {
            background: rgba(239, 68, 68, 0.1);
            color: var(--status-error);
        }
        .listing-modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-default);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .listing-btn-cancel {
            background: transparent;
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .listing-btn-cancel:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }
        .listing-btn-confirm {
            background: linear-gradient(135deg, #e53238, #f5af02);
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .listing-btn-confirm:hover {
            opacity: 0.9;
        }
        .listing-btn-confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .listing-generating {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        .listing-generating .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-default);
            border-top-color: var(--brand-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Summary card */
        .summary-card {
            background: var(--bg-primary);
            border: 2px solid var(--brand-indigo);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
        }
        .summary-total {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--value-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .summary-count {
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        footer { text-align: center; margin-top: 40px; color: var(--text-muted); font-size: 0.9rem; }
        footer a { color: var(--brand-purple); text-decoration: none; transition: color 0.2s; }
        footer a:hover { color: var(--brand-cyan); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* Pulse animation only for loading states, not disabled */
        
        .thinking {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--brand-indigo);
            border-radius: 12px;
            display: none;
            min-height: 200px;
        }
        .thinking.show { display: block; }
        .thinking-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .thinking-calc { width: 32px; height: 32px; }
        .thinking-calc svg { width: 100%; height: 100%; }
        .calc-display {
            font-family: 'Courier New', monospace;
            font-size: 6px;
            font-weight: bold;
            fill: var(--brand-cyan);
        }
        .calc-num1 { animation: num1 2s steps(1) infinite; }
        @keyframes num1 {
            0% { transform: translateY(0); }
            25% { transform: translateY(-6px); }
            50% { transform: translateY(-12px); }
            75% { transform: translateY(-6px); }
        }
        /* Calculator button press animations */
        .calc-btn1 { animation: btnPress1 1.2s ease-in-out infinite; }
        .calc-btn2 { animation: btnPress2 1.2s ease-in-out infinite; }
        .calc-btn3 { animation: btnPress3 1.2s ease-in-out infinite; }
        .calc-btn4 { animation: btnPress4 1.2s ease-in-out infinite; }
        .calc-btn5 { animation: btnPress5 1.2s ease-in-out infinite; }
        .calc-btn6 { animation: btnPress6 1.2s ease-in-out infinite; }
        @keyframes btnPress1 {
            0%, 16%, 100% { opacity: 1; transform: scale(1); }
            8% { opacity: 0.6; transform: scale(0.9); }
        }
        @keyframes btnPress2 {
            0%, 16%, 33%, 100% { opacity: 1; transform: scale(1); }
            24% { opacity: 0.6; transform: scale(0.9); }
        }
        @keyframes btnPress3 {
            0%, 33%, 50%, 100% { opacity: 1; transform: scale(1); }
            41% { opacity: 0.6; transform: scale(0.9); }
        }
        @keyframes btnPress4 {
            0%, 50%, 66%, 100% { opacity: 1; transform: scale(1); }
            58% { opacity: 0.6; transform: scale(0.9); }
        }
        @keyframes btnPress5 {
            0%, 66%, 83%, 100% { opacity: 1; transform: scale(1); }
            75% { opacity: 0.6; transform: scale(0.9); }
        }
        @keyframes btnPress6 {
            0%, 83%, 100% { opacity: 1; transform: scale(1); }
            91% { opacity: 0.6; transform: scale(0.9); }
        }
        .thinking-title { color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; }
        .thinking-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .thinking-step {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
            font-size: 0.85rem;
            transition: color 0.3s;
        }
        .thinking-step.active { color: var(--brand-cyan); }
        .thinking-step.done { color: var(--status-success); }
        .thinking-step .icon { width: 18px; text-align: center; }
        .thinking-step.active .icon::before { content: '‚ü≥'; }
        .thinking-step.done .icon::before { content: '‚úì'; }
        .thinking-step.pending .icon::before { content: '‚óã'; }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .action-buttons button { flex: 1; }
        
        .api-setup { text-align: center; padding: 20px 0; }
        .api-setup-title { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; }
        .api-setup-info {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        .api-setup-info ol { margin-left: 20px; color: var(--text-secondary); }
        .api-setup-info li { margin: 8px 0; }
        .api-setup-info a { color: var(--brand-cyan); }
        .error-msg {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--status-error);
            color: var(--status-error);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CollectionCalc</h1>
            <p class="subtitle">AI-Powered Collectible Valuation</p>
        </header>
        
        <div class="card" id="apiSetup" style="display: none;">
            <div class="api-setup">
                <div class="api-setup-title">üîë Enter Your Anthropic API Key</div>
                <div class="api-setup-info">
                    <strong>How to get an API key:</strong>
                    <ol>
                        <li>Go to <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></li>
                        <li>Sign up or log in</li>
                        <li>Go to API Keys section</li>
                        <li>Create a new key and copy it</li>
                    </ol>
                </div>
                <div id="apiError" class="error-msg" style="display: none;"></div>
                <div class="form-group">
                    <input type="password" id="apiKeyInput" placeholder="sk-ant-..." style="font-family: monospace;">
                </div>
                <button onclick="saveApiKey()">Save & Continue</button>
            </div>
        </div>
        
        <div id="mainApp" style="display: none;">
            <div class="mode-toggle">
                <button class="mode-btn active" id="modeManual" onclick="setMode('manual')">‚úèÔ∏è Manual Entry</button>
                <button class="mode-btn" id="modePhoto" onclick="setMode('photo')">üì∏ Photo Upload</button>
            </div>
            
            <div class="card">
                <!-- Manual Entry Mode -->
                <div id="manualMode">
                    <form id="valuationForm">
                        <div class="form-group">
                            <label for="title">Comic Title</label>
                            <input type="text" id="title" placeholder="e.g. Amazing Spider-Man (or ASM)" required>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label for="issue">Issue #</label>
                                <input type="text" id="issue" placeholder="e.g. 300" required>
                            </div>
                            <div class="form-group">
                                <label for="grade">Grade</label>
                                <select id="grade">
                                    <option value="NM">Near Mint (NM)</option>
                                    <option value="VF" selected>Very Fine (VF)</option>
                                    <option value="FN">Fine (FN)</option>
                                    <option value="VG">Very Good (VG)</option>
                                    <option value="G">Good (G)</option>
                                    <option value="FR">Fair (FR)</option>
                                    <option value="PR">Poor (PR)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" id="submitBtn">Get Valuation</button>
                    </form>
                </div>
                
                <!-- Photo Upload Mode -->
                <div id="photoMode" style="display: none;">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click();">
                        <input type="file" id="photoInput" class="upload-input" accept=".jpg,.jpeg,.png,.webp,.heic" multiple onchange="handlePhotoUpload(this.files)">
                        <div class="upload-icon">üì∏</div>
                        <div class="upload-title">Click to upload or drag & drop</div>
                        <div class="upload-subtitle">Select one or multiple comic photos</div>
                    </div>
                </div>
                
                <!-- Bulk Extracted Items -->
                <div id="bulkMode" style="display: none;">
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progressText">Calculating...</div>
                    </div>
                    
                    <div id="itemsList"></div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn-secondary" onclick="resetToPhoto()">‚Üê Add More Photos</button>
                        <button type="button" id="valuateAllBtn" onclick="valuateAll()">Get All Valuations</button>
                    </div>
                </div>
                
                <!-- Results Summary (for bulk) -->
                <div id="resultsMode" style="display: none;">
                    <div class="summary-card">
                        <div class="result-label">Total Collection Value</div>
                        <div class="summary-total" id="totalValue">$0.00</div>
                        <div class="summary-count" id="itemCount">0 items valued</div>
                    </div>
                    
                    <div class="sort-controls">
                        <label for="sortSelect">Sort by:</label>
                        <select id="sortSelect" onchange="sortResults(this.value)">
                            <option value="default">Order Added</option>
                            <option value="value-high">Value (High to Low)</option>
                            <option value="value-low">Value (Low to High)</option>
                            <option value="title">Title (A-Z)</option>
                        </select>
                    </div>
                    
                    <div id="resultsList"></div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn-secondary" onclick="resetApp()">‚Üê Start Over</button>
                        <button type="button" onclick="downloadExcel()">üì• Download Excel</button>
                    </div>
                </div>
                
                <!-- Single Result (for manual entry) -->
                <div class="result" id="result">
                    <div class="result-card" id="resultCard">
                        <div id="resultContent"></div>
                    </div>
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button type="button" class="btn-secondary" onclick="resetApp()">‚Üê Value Another</button>
                    </div>
                </div>
                
                <!-- Thinking Animation -->
                <div class="thinking" id="thinking">
                    <div class="thinking-header">
                        <div class="thinking-calc">
                            <svg viewBox="0 0 32 32" fill="none">
                                <rect x="4" y="2" width="24" height="28" rx="3" stroke="url(#calcGrad)" stroke-width="2.5" fill="none"/>
                                <rect x="7" y="5" width="18" height="7" rx="1" fill="#0f0f1a" stroke="var(--brand-indigo)" stroke-width="1"/>
                                <g clip-path="url(#displayClip)">
                                    <text x="9" y="10.5" class="calc-display calc-num1">$1,247</text>
                                </g>
                                <rect class="calc-btn1" x="7" y="15" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                                <rect class="calc-btn2" x="14" y="15" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                                <rect class="calc-btn3" x="21" y="15" width="4" height="3" rx="0.5" fill="var(--brand-purple)"/>
                                <rect class="calc-btn4" x="7" y="20" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                                <rect class="calc-btn5" x="14" y="20" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                                <rect class="calc-btn6" x="21" y="20" width="4" height="3" rx="0.5" fill="var(--brand-cyan)"/>
                                <defs>
                                    <linearGradient id="calcGrad" x1="4" y1="2" x2="28" y2="30" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#4f46e5"/><stop offset="1" stop-color="#7c3aed"/>
                                    </linearGradient>
                                    <clipPath id="displayClip"><rect x="7" y="5" width="18" height="7"/></clipPath>
                                </defs>
                            </svg>
                        </div>
                        <span class="thinking-title" id="thinkingTitle">Calculating...</span>
                    </div>
                    <div class="thinking-steps">
                        <div class="thinking-step pending" id="step1"><span class="icon"></span><span id="step1Text">Checking database for matches</span></div>
                        <div class="thinking-step pending" id="step2"><span class="icon"></span><span id="step2Text">Searching market data</span></div>
                        <div class="thinking-step pending" id="step3"><span class="icon"></span><span id="step3Text">Crunching the numbers</span></div>
                        <div class="thinking-step pending" id="step4"><span class="icon"></span><span id="step4Text">Calculating confidence score</span></div>
                        <div class="thinking-step pending" id="step5"><span class="icon"></span><span id="step5Text">Generating valuation</span></div>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-secondary btn-small" onclick="changeApiKey()">üîë Change API Key</button>
            </div>
        </div>
        
        <footer>
            Built with ‚òï by <a href="https://github.com/Fevit1/collectioncalc" target="_blank">CollectionCalc</a>
        </footer>
    </div>
    
    <!-- eBay Listing Preview Modal -->
    <div class="listing-modal-overlay" id="listingModal">
        <div class="listing-modal">
            <div class="listing-modal-header">
                <h3>üì¶ Preview eBay Listing</h3>
                <button class="listing-modal-close" onclick="closeListingModal()">&times;</button>
            </div>
            <div class="listing-modal-body" id="listingModalBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="listing-modal-footer">
                <button class="listing-btn-cancel" onclick="closeListingModal()">Cancel</button>
                <button class="listing-btn-confirm" id="confirmListingBtn" onclick="confirmListing()">
                    Confirm & List on eBay
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://collectioncalc.onrender.com';
        let apiKey = localStorage.getItem('anthropic_api_key') || '';
        let currentMode = 'manual';
        let extractedItems = [];
        let currentSort = 'default';
        let originalOrder = []; // Store original order for "Order Added" sort
        
        // eBay integration state
        let ebayUserId = localStorage.getItem('ebay_user_id') || generateUserId();
        let ebayConnected = false;
        
        function generateUserId() {
            const id = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('ebay_user_id', id);
            return id;
        }
        
        async function checkEbayConnection() {
            try {
                const response = await fetch(`${API_URL}/api/ebay/status?user_id=${ebayUserId}`);
                const data = await response.json();
                ebayConnected = data.connected;
                return ebayConnected;
            } catch (e) {
                console.log('eBay status check failed:', e);
                return false;
            }
        }
        
        async function connectEbay() {
            try {
                const response = await fetch(`${API_URL}/api/ebay/auth?user_id=${ebayUserId}`);
                const data = await response.json();
                
                // Open eBay auth in popup
                const popup = window.open(data.auth_url, 'ebay_auth', 'width=600,height=700');
                
                // Listen for completion
                window.addEventListener('message', async (event) => {
                    if (event.data.type === 'ebay_auth') {
                        if (event.data.success) {
                            ebayConnected = true;
                            updateEbayUI();
                        }
                    }
                });
            } catch (e) {
                console.error('eBay connect failed:', e);
                alert('Failed to connect to eBay. Please try again.');
            }
        }
        
        function updateEbayUI() {
            const ebaySection = document.getElementById('ebaySection');
            if (ebaySection) {
                if (ebayConnected) {
                    ebaySection.innerHTML = `
                        <p class="ebay-connected">‚úì eBay Connected</p>
                        <div class="list-buttons" id="listButtons"></div>
                    `;
                } else {
                    ebaySection.innerHTML = `
                        <button class="ebay-connect-btn" onclick="connectEbay()">
                            <svg class="ebay-logo" viewBox="0 0 24 24" fill="currentColor"><path d="M7.95 5.63c-3.16 0-5.7 2.31-5.7 5.16 0 2.13 1.39 3.94 3.34 4.65v.01c.3.11.59.25.86.41.97.57 1.62 1.57 1.62 2.73 0 1.78-1.5 3.22-3.36 3.22-.93 0-1.77-.37-2.38-.96l-.01-.01c-.15-.15-.38-.15-.53 0-.15.15-.15.38 0 .53.76.74 1.8 1.19 2.92 1.19 2.31 0 4.11-1.79 4.11-3.97 0-1.51-.85-2.82-2.1-3.55-.32-.19-.67-.35-1.03-.48v-.01c-1.55-.57-2.62-2.01-2.62-3.71 0-2.22 1.89-4.01 4.23-4.01 1.4 0 2.64.66 3.41 1.67.12.16.35.19.51.07.16-.12.19-.35.07-.51-.92-1.21-2.41-2-4.09-2h.75zM16.05 5.63c-3.16 0-5.7 2.31-5.7 5.16s2.54 5.16 5.7 5.16 5.7-2.31 5.7-5.16-2.54-5.16-5.7-5.16zm0 9.17c-2.34 0-4.23-1.79-4.23-4.01s1.89-4.01 4.23-4.01 4.23 1.79 4.23 4.01-1.89 4.01-4.23 4.01z"/></svg>
                            Connect eBay Account
                        </button>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">List items directly from your valuations</p>
                    `;
                }
            }
        }
        
        // Pending listing data
        let pendingListing = null;
        
        // Placeholder image (base64 encoded SVG with calculator icon)
        const PLACEHOLDER_IMAGE = `data:image/svg+xml;base64,${btoa(`
            <svg xmlns="http://www.w3.org/2000/svg" width="300" height="300" viewBox="0 0 300 300">
                <defs>
                    <linearGradient id="calcGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#4f46e5"/>
                        <stop offset="100%" stop-color="#7c3aed"/>
                    </linearGradient>
                    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#0f0f1a"/>
                        <stop offset="100%" stop-color="#1a1a2e"/>
                    </linearGradient>
                </defs>
                <rect width="300" height="300" fill="url(#bgGrad)"/>
                <!-- Calculator icon - centered and larger -->
                <g transform="translate(102, 60) scale(3)">
                    <rect x="4" y="2" width="24" height="28" rx="3" stroke="url(#calcGrad)" stroke-width="2.5" fill="none"/>
                    <rect x="7" y="5" width="18" height="7" rx="1" fill="#0f0f1a" stroke="#4f46e5" stroke-width="1"/>
                    <text x="9" y="10.5" fill="#06b6d4" font-family="Arial" font-size="5" font-weight="bold">$---.--</text>
                    <rect x="7" y="15" width="4" height="3" rx="0.5" fill="#4f46e5"/>
                    <rect x="14" y="15" width="4" height="3" rx="0.5" fill="#4f46e5"/>
                    <rect x="21" y="15" width="4" height="3" rx="0.5" fill="#7c3aed"/>
                    <rect x="7" y="20" width="4" height="3" rx="0.5" fill="#4f46e5"/>
                    <rect x="14" y="20" width="4" height="3" rx="0.5" fill="#4f46e5"/>
                    <rect x="21" y="20" width="4" height="3" rx="0.5" fill="#06b6d4"/>
                    <rect x="7" y="25" width="4" height="3" rx="0.5" fill="#4f46e5"/>
                    <rect x="14" y="25" width="4" height="3" rx="0.5" fill="#4f46e5"/>
                    <rect x="21" y="25" width="4" height="3" rx="0.5" fill="#10b981"/>
                </g>
                <text x="150" y="210" text-anchor="middle" fill="#7c3aed" font-family="Arial" font-size="16" font-weight="bold">CollectionCalc</text>
                <text x="150" y="240" text-anchor="middle" fill="#94a3b8" font-family="Arial" font-size="12">Photo Coming Soon</text>
                <text x="150" y="260" text-anchor="middle" fill="#64748b" font-family="Arial" font-size="10">Add your photo on eBay</text>
            </svg>
        `)}`;
        
        async function listOnEbay(title, issue, price, tier) {
            if (!ebayConnected) {
                alert('Please connect your eBay account first');
                return;
            }
            
            // Get the grade from the form
            const grade = document.getElementById('grade')?.value || 'VF';
            
            // Store pending listing data
            pendingListing = { title, issue, price, tier, grade, description: '' };
            
            // Show modal with loading state
            const modal = document.getElementById('listingModal');
            const modalBody = document.getElementById('listingModalBody');
            
            modalBody.innerHTML = `
                <div class="listing-generating">
                    <div class="spinner"></div>
                    <p>Generating professional description...</p>
                </div>
            `;
            
            modal.classList.add('show');
            document.getElementById('confirmListingBtn').disabled = true;
            
            try {
                // Generate description via API
                const response = await fetch(`${API_URL}/api/ebay/generate-description`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        issue: issue,
                        grade: grade,
                        price: price
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    pendingListing.description = result.description;
                    showListingPreview();
                } else {
                    throw new Error(result.error || 'Failed to generate description');
                }
            } catch (e) {
                console.error('Description generation error:', e);
                // Use a basic fallback description
                pendingListing.description = `<p><b>Condition:</b> ${grade}</p><p>Please review photos carefully. Feel free to ask any questions!</p>`;
                showListingPreview();
            }
        }
        
        async function listItemOnEbay(idx) {
            const item = extractedItems[idx];
            if (!item) return;
            
            if (!ebayConnected) {
                connectEbay();
                return;
            }
            
            const price = item.selectedPrice || item.fair_value || item.value || 0;
            const tierNames = { quick: 'Quick Sale', fair: 'Fair Value', high: 'High End' };
            const tier = tierNames[item.selectedTier] || 'Fair Value';
            const grade = item.grade || 'VF';
            
            // Store pending listing data
            pendingListing = { 
                title: item.title, 
                issue: item.issue, 
                price, 
                tier, 
                grade, 
                description: '' 
            };
            
            // Show modal with loading state
            const modal = document.getElementById('listingModal');
            const modalBody = document.getElementById('listingModalBody');
            
            modalBody.innerHTML = `
                <div class="listing-generating">
                    <div class="spinner"></div>
                    <p>Generating professional description...</p>
                </div>
            `;
            
            modal.classList.add('show');
            document.getElementById('confirmListingBtn').disabled = true;
            
            try {
                // Generate description via API
                const response = await fetch(`${API_URL}/api/ebay/generate-description`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: item.title,
                        issue: item.issue,
                        grade: grade,
                        price: price
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    pendingListing.description = result.description;
                    showListingPreview();
                } else {
                    throw new Error(result.error || 'Failed to generate description');
                }
            } catch (e) {
                console.error('Description generation error:', e);
                pendingListing.description = `<p><b>Condition:</b> ${grade}</p><p>Please review photos carefully. Feel free to ask any questions!</p>`;
                showListingPreview();
            }
        }
        
        function showListingPreview() {
            const modalBody = document.getElementById('listingModalBody');
            const { title, issue, price, tier, grade, description } = pendingListing;
            
            modalBody.innerHTML = `
                <div class="listing-preview-row">
                    <div class="listing-preview-label">Title</div>
                    <div class="listing-preview-value">${title} #${issue} - ${grade} Condition</div>
                </div>
                
                <div class="listing-preview-row">
                    <div class="listing-preview-label">Price (${tier})</div>
                    <div class="listing-preview-price">$${price.toFixed(2)}</div>
                </div>
                
                <div class="listing-preview-row">
                    <div class="listing-preview-label">Placeholder Image</div>
                    <img src="${PLACEHOLDER_IMAGE}" alt="Photo Coming Soon" class="listing-preview-image">
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">
                        You can add your actual photos after listing on eBay
                    </p>
                </div>
                
                <div class="listing-preview-row">
                    <div class="listing-preview-label">Description (editable)</div>
                    <textarea class="listing-description-edit" id="listingDescription" 
                        oninput="validateListingDescription()">${escapeHtml(description)}</textarea>
                    <div class="listing-validation" id="descriptionValidation"></div>
                </div>
            `;
            
            document.getElementById('confirmListingBtn').disabled = false;
            validateListingDescription();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function validateListingDescription() {
            const description = document.getElementById('listingDescription').value;
            const validationDiv = document.getElementById('descriptionValidation');
            const confirmBtn = document.getElementById('confirmListingBtn');
            
            // Basic client-side validation
            const issues = [];
            if (description.length > 4000) {
                issues.push(`Too long (${description.length}/4000 chars)`);
            }
            if (description.length < 50) {
                issues.push('Too short (minimum 50 characters)');
            }
            if (/https?:\/\/|www\./i.test(description)) {
                issues.push('External links not allowed');
            }
            
            if (issues.length > 0) {
                validationDiv.className = 'listing-validation invalid';
                validationDiv.textContent = '‚ö†Ô∏è ' + issues.join(', ');
                confirmBtn.disabled = true;
            } else {
                validationDiv.className = 'listing-validation valid';
                validationDiv.textContent = '‚úì Description looks good (' + description.length + '/4000 chars)';
                confirmBtn.disabled = false;
            }
            
            // Update pending listing
            pendingListing.description = description;
        }
        
        function closeListingModal() {
            document.getElementById('listingModal').classList.remove('show');
            pendingListing = null;
        }
        
        async function confirmListing() {
            if (!pendingListing) return;
            
            const confirmBtn = document.getElementById('confirmListingBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Creating listing...';
            
            try {
                const response = await fetch(`${API_URL}/api/ebay/list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: ebayUserId,
                        title: pendingListing.title,
                        issue: pendingListing.issue,
                        price: pendingListing.price,
                        grade: pendingListing.grade,
                        description: pendingListing.description
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeListingModal();
                    alert(`‚úÖ Listed successfully!\n\nView your listing:\n${result.listing_url}`);
                    window.open(result.listing_url, '_blank');
                } else if (result.needs_setup) {
                    alert(`‚ö†Ô∏è Setup Required\n\n${result.error}\n\nPlease set up your seller account on eBay first.`);
                } else {
                    alert(`‚ùå Listing failed\n\n${result.error}`);
                }
            } catch (e) {
                console.error('Listing error:', e);
                alert(`‚ùå Error creating listing: ${e.message}`);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm & List on eBay';
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (apiKey && apiKey.startsWith('sk-ant-')) {
                document.getElementById('apiSetup').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
            } else {
                document.getElementById('apiSetup').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
            }
            
            // Check eBay connection status
            await checkEbayConnection();
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) handlePhotoUpload(e.dataTransfer.files);
            });
        });
        
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key.startsWith('sk-ant-')) {
                localStorage.setItem('anthropic_api_key', key);
                apiKey = key;
                document.getElementById('apiSetup').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
            } else {
                document.getElementById('apiError').textContent = 'Invalid API key. Should start with sk-ant-';
                document.getElementById('apiError').style.display = 'block';
            }
        }
        
        function changeApiKey() {
            if (confirm('Clear your API key?')) {
                localStorage.removeItem('anthropic_api_key');
                location.reload();
            }
        }
        
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('modeManual').classList.toggle('active', mode === 'manual');
            document.getElementById('modePhoto').classList.toggle('active', mode === 'photo');
            document.getElementById('manualMode').style.display = mode === 'manual' ? 'block' : 'none';
            document.getElementById('photoMode').style.display = mode === 'photo' ? 'block' : 'none';
            document.getElementById('bulkMode').style.display = 'none';
            document.getElementById('resultsMode').style.display = 'none';
            document.getElementById('result').classList.remove('show');
        }
        
        function resetToPhoto() {
            document.getElementById('bulkMode').style.display = 'none';
            document.getElementById('photoMode').style.display = 'block';
        }
        
        function resetApp() {
            extractedItems = [];
            originalOrder = [];
            currentSort = 'default';
            document.getElementById('result').classList.remove('show');
            document.getElementById('resultsMode').style.display = 'none';
            document.getElementById('bulkMode').style.display = 'none';
            // Reset sort dropdown
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) sortSelect.value = 'default';
            if (currentMode === 'photo') {
                document.getElementById('photoMode').style.display = 'block';
            }
        }
        
        // Photo upload and extraction
        async function handlePhotoUpload(files) {
            if (!files || files.length === 0) return;
            
            const fileArray = Array.from(files);
            document.getElementById('photoMode').style.display = 'none';
            document.getElementById('bulkMode').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('valuateAllBtn').disabled = true;
            
            for (let i = 0; i < fileArray.length; i++) {
                const file = fileArray[i];
                updateProgress((i / fileArray.length) * 100, `Extracting ${i + 1} of ${fileArray.length}: ${file.name}`);
                
                try {
                    const extracted = await extractFromPhoto(file);
                    extractedItems.push(extracted);
                    renderItemsList();
                } catch (error) {
                    console.error('Error extracting:', error);
                    extractedItems.push({
                        title: file.name.replace(/\.[^/.]+$/, ''),
                        issue: '',
                        publisher: '',
                        year: '',
                        grade: 'VF',
                        edition: 'unknown',
                        error: error.message
                    });
                    renderItemsList();
                }
                
                // 3 second delay between photos
                if (i < fileArray.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }
            }
            
            updateProgress(100, 'Extraction complete!');
            setTimeout(() => {
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('valuateAllBtn').disabled = false;
            }, 1000);
        }
        
        // Compress image to stay under Anthropic's 5MB limit
        // Uses smart compression: tries high quality first, reduces only as needed
        async function compressImage(file, maxSizeBytes = 4.8 * 1024 * 1024) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = reject;
                reader.onload = (e) => {
                    const img = new Image();
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Start with original dimensions
                        let width = img.width;
                        let height = img.height;
                        
                        // Try different quality levels, then resize if needed
                        const qualities = [0.92, 0.85, 0.75, 0.65, 0.5];
                        const scales = [1, 0.85, 0.7, 0.5];
                        
                        for (const scale of scales) {
                            canvas.width = Math.round(width * scale);
                            canvas.height = Math.round(height * scale);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            for (const quality of qualities) {
                                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                                const base64 = dataUrl.split(',')[1];
                                const sizeBytes = base64.length; // base64 string length is the size Anthropic checks
                                
                                if (sizeBytes <= maxSizeBytes) {
                                    console.log(`Compressed image: ${(sizeBytes / 1024 / 1024).toFixed(2)}MB base64 at ${Math.round(scale * 100)}% scale, ${Math.round(quality * 100)}% quality`);
                                    resolve({ base64, mediaType: 'image/jpeg' });
                                    return;
                                }
                            }
                        }
                        
                        // Last resort: smallest scale and quality
                        canvas.width = Math.round(width * 0.4);
                        canvas.height = Math.round(height * 0.4);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.4);
                        const base64 = dataUrl.split(',')[1];
                        console.log(`Compressed image (fallback): ${(base64.length / 1024 / 1024).toFixed(2)}MB base64`);
                        resolve({ base64, mediaType: 'image/jpeg' });
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function extractFromPhoto(file) {
            // Check file size and compress if needed (Anthropic limit is 5MB base64)
            // Base64 encoding adds ~33%, so 3.5MB file becomes ~4.7MB base64
            const fileSizeMB = file.size / 1024 / 1024;
            let base64Data, mediaType;
            
            if (fileSizeMB > 3.5) {
                console.log(`Image ${file.name} is ${fileSizeMB.toFixed(2)}MB, compressing...`);
                const compressed = await compressImage(file);
                base64Data = compressed.base64;
                mediaType = compressed.mediaType;
            } else {
                // File is small enough, use as-is
                base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                const extension = file.name.split('.').pop().toLowerCase();
                const mediaTypeMap = { 'jpg': 'image/jpeg', 'jpeg': 'image/jpeg', 'png': 'image/png', 'webp': 'image/webp', 'heic': 'image/heic' };
                mediaType = mediaTypeMap[extension] || 'image/jpeg';
            }
            
            const prompt = `Analyze this comic book image and extract information. Return ONLY a JSON object with these fields:

- title: Comic book title (usually the largest text on the cover). Include the main series name only, NOT "Annual" or "Special" - those go in issue_type.
- issue: Issue number - IMPORTANT: Look for a "#" symbol followed by a number, typically in the TOP-LEFT area near the price. IGNORE prices like "60¬¢", "$1.00", "25p" - these are NOT issue numbers. The issue number usually appears as "#242" or "No. 242". Just return the number, no # symbol.
- issue_type: CRITICAL - Look carefully for these indicators on the cover:
  * "Annual" or "ANNUAL" ‚Üí return "Annual"
  * "King-Size Special" or "KING-SIZE SPECIAL" ‚Üí return "Annual" (these are annuals)
  * "Giant-Size" or "GIANT-SIZE" ‚Üí return "Giant-Size"
  * "Special" or "SPECIAL" (standalone) ‚Üí return "Special"
  * "Special Edition" ‚Üí return "Special Edition"
  * If none of these are present ‚Üí return "Regular"
  These indicators are often in LARGE TEXT at the top of the cover or in a banner. They dramatically affect the comic's value - an Annual #6 is completely different from Regular #6.
- publisher: Publisher name (Marvel, DC, Image, etc.) - often in small text at top
- year: Publication year - look for copyright text or indicia, usually small text
- grade: Estimated condition grade (GM, GD, VG, FN, VF, NM, MT) - be conservative
- edition: Look at the BOTTOM-LEFT CORNER. If you see a UPC BARCODE, return "newsstand". If you see ARTWORK or LOGO, return "direct". If unclear, return "unknown".
- printing: Look for "2nd Printing", "3rd Print", "Second Printing", etc. anywhere on cover. Return "1st" if no printing indicator found, otherwise "2nd", "3rd", etc.
- cover: Look for cover variant indicators like "Cover A", "Cover B", "Variant Cover", "1:25", "1:50", "Incentive", "Virgin", etc. Return the variant info if found, otherwise empty string.
- variant: Other variant description if applicable (e.g., "McFarlane variant", "Artgerm cover"), otherwise empty string

CRITICAL RULES:
1. Do NOT confuse prices (60¬¢, $1.50, 25p) with issue numbers. Issue numbers are preceded by "#" or "No." and are typically 1-4 digits.
2. ALWAYS check for "Annual", "King-Size Special", "Giant-Size", or "Special" - these are DIFFERENT series than the regular comic and have very different values. Look at banners, large text at the top, and the spine.
3. If you see "KING-SIZE SPECIAL" anywhere, the issue_type MUST be "Annual".

Be accurate. If unsure about any field, use reasonable estimates.`;
            
            const response = await fetch(`${API_URL}/api/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-API-Key': apiKey },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    messages: [{ role: 'user', content: [
                        { type: 'image', source: { type: 'base64', media_type: mediaType, data: base64Data }},
                        { type: 'text', text: prompt }
                    ]}]
                })
            });
            
            const data = await response.json();
            if (data.error) throw new Error(data.error.message || 'API Error');
            
            const textContent = data.content.filter(item => item.type === 'text').map(item => item.text).join('');
            const jsonMatch = textContent.match(/\{[\s\S]*\}/);
            
            if (jsonMatch) {
                const extracted = JSON.parse(jsonMatch[0]);
                // Include the image for preview and eBay listing
                extracted.image = `data:${mediaType};base64,${base64Data}`;
                return extracted;
            } else {
                throw new Error('Could not extract data');
            }
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        function renderItemsList() {
            const container = document.getElementById('itemsList');
            container.innerHTML = extractedItems.map((item, idx) => `
                <div class="item-card ${item.value ? 'has-value' : ''}" id="item-${idx}">
                    <div class="item-header">
                        <span class="item-number">${idx + 1}</span>
                        <span class="item-title">${item.title || 'Unknown'} #${item.issue || '?'}</span>
                        ${item.value ? `<span class="item-value">$${item.value.toFixed(2)}</span>` : ''}
                        <button class="item-delete" onclick="deleteItem(${idx})">√ó</button>
                    </div>
                    <div class="item-content" style="display: flex; gap: 15px;">
                        ${item.image ? `<img src="${item.image}" alt="Comic cover" style="width: 80px; height: auto; border-radius: 4px; object-fit: cover;">` : ''}
                        <div class="item-fields-wrapper" style="flex: 1;">
                    <div class="item-fields">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" value="${item.title || ''}" onchange="updateItem(${idx}, 'title', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Issue</label>
                            <input type="text" value="${item.issue || ''}" onchange="updateItem(${idx}, 'issue', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Year</label>
                            <input type="text" value="${item.year || ''}" onchange="updateItem(${idx}, 'year', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Grade</label>
                            <select onchange="updateItem(${idx}, 'grade', this.value)">
                                <option value="NM" ${item.grade === 'NM' ? 'selected' : ''}>NM</option>
                                <option value="VF" ${item.grade === 'VF' || !item.grade ? 'selected' : ''}>VF</option>
                                <option value="FN" ${item.grade === 'FN' ? 'selected' : ''}>FN</option>
                                <option value="VG" ${item.grade === 'VG' ? 'selected' : ''}>VG</option>
                                <option value="G" ${item.grade === 'G' || item.grade === 'GD' ? 'selected' : ''}>G</option>
                            </select>
                        </div>
                    </div>
                    <div class="item-fields" style="margin-top: 10px;">
                        <div class="form-group">
                            <label>Printing</label>
                            <select onchange="updateItem(${idx}, 'printing', this.value)">
                                <option value="1st" ${item.printing === '1st' || !item.printing ? 'selected' : ''}>1st</option>
                                <option value="2nd" ${item.printing === '2nd' ? 'selected' : ''}>2nd</option>
                                <option value="3rd" ${item.printing === '3rd' ? 'selected' : ''}>3rd</option>
                                <option value="4th" ${item.printing === '4th' ? 'selected' : ''}>4th+</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cover</label>
                            <input type="text" value="${item.cover || ''}" placeholder="A, B, 1:25..." onchange="updateItem(${idx}, 'cover', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Variant</label>
                            <input type="text" value="${item.variant || ''}" placeholder="Artist name..." onchange="updateItem(${idx}, 'variant', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Edition</label>
                            <select onchange="updateItem(${idx}, 'edition', this.value)">
                                <option value="direct" ${item.edition === 'direct' ? 'selected' : ''}>Direct</option>
                                <option value="newsstand" ${item.edition === 'newsstand' ? 'selected' : ''}>Newsstand</option>
                                <option value="unknown" ${item.edition === 'unknown' || !item.edition ? 'selected' : ''}>Unknown</option>
                            </select>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateItem(idx, field, value) {
            extractedItems[idx][field] = value;
            
            // Update header if title or issue changed
            if (field === 'title' || field === 'issue') {
                const card = document.getElementById('item-' + idx);
                if (card) {
                    const titleSpan = card.querySelector('.item-title');
                    if (titleSpan) {
                        const item = extractedItems[idx];
                        titleSpan.textContent = `${item.title || 'Unknown'} #${item.issue || '?'}`;
                    }
                }
            }
        }
        
        function deleteItem(idx) {
            extractedItems.splice(idx, 1);
            renderItemsList();
            if (extractedItems.length === 0) {
                resetToPhoto();
            }
        }
        
        async function valuateAll() {
            const btn = document.getElementById('valuateAllBtn');
            btn.disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            
            for (let i = 0; i < extractedItems.length; i++) {
                const item = extractedItems[i];
                updateProgress((i / extractedItems.length) * 100, `Valuating ${i + 1} of ${extractedItems.length}`);
                
                // Show thinking animation for this comic
                showThinking(`Calculating: ${item.title} #${item.issue}`, [
                    'Checking database for matches',
                    'Searching market data',
                    'Crunching the numbers',
                    'Calculating confidence score',
                    'Generating valuation'
                ]);
                
                try {
                    const result = await getValuation(item);
                    extractedItems[i] = { ...item, ...result };
                    renderItemsList();
                    
                    // Brief pause for UI update (Tier 2 rate limits allow rapid calls)
                    if (i < extractedItems.length - 1) {
                        updateProgress(((i + 1) / extractedItems.length) * 100, `Starting next valuation...`);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                } catch (error) {
                    extractedItems[i].error = error.message;
                }
            }
            
            hideThinking();
            btn.disabled = false;
            document.getElementById('progressContainer').style.display = 'none';
            showResults();
        }
        
        async function getValuation(item, forceRefresh = false) {
            const response = await fetch(`${API_URL}/api/valuate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: item.title,
                    issue: item.issue,
                    year: parseInt(item.year) || null,
                    publisher: item.publisher || null,
                    grade: item.grade || 'VF',
                    printing: item.printing || '1st',
                    cover: item.cover || '',
                    variant: item.variant || '',
                    edition: item.edition || '',
                    issue_type: item.issue_type || 'Regular',
                    force_refresh: forceRefresh
                })
            });
            
            const json = await response.json();
            if (json.error) throw new Error(json.error);
            
            return {
                value: json.final_value,
                confidence: json.confidence,
                confidence_score: json.confidence_score,
                source: json.source,
                reasoning: json.reasoning,
                ebay_sales: json.ebay_sales,
                ebay_price_range: json.ebay_price_range,
                sales_data: json.sales_data || [],
                quick_sale: json.quick_sale,
                fair_value: json.fair_value,
                high_end: json.high_end,
                lowest_bin: json.lowest_bin
            };
        }
        
        function sortResults(sortBy) {
            currentSort = sortBy;
            
            // Store original order if not already stored
            if (originalOrder.length === 0 || originalOrder.length !== extractedItems.length) {
                originalOrder = extractedItems.map((item, idx) => ({ ...item, originalIndex: idx }));
            }
            
            // Sort based on selection
            switch (sortBy) {
                case 'value-high':
                    extractedItems.sort((a, b) => {
                        const aVal = a.selectedPrice || a.fair_value || a.value || 0;
                        const bVal = b.selectedPrice || b.fair_value || b.value || 0;
                        return bVal - aVal;
                    });
                    break;
                case 'value-low':
                    extractedItems.sort((a, b) => {
                        const aVal = a.selectedPrice || a.fair_value || a.value || 0;
                        const bVal = b.selectedPrice || b.fair_value || b.value || 0;
                        return aVal - bVal;
                    });
                    break;
                case 'title':
                    extractedItems.sort((a, b) => {
                        const aTitle = (a.title || '').toLowerCase();
                        const bTitle = (b.title || '').toLowerCase();
                        if (aTitle === bTitle) {
                            return (parseInt(a.issue) || 0) - (parseInt(b.issue) || 0);
                        }
                        return aTitle.localeCompare(bTitle);
                    });
                    break;
                case 'default':
                default:
                    // Restore original order
                    if (originalOrder.length > 0) {
                        extractedItems = originalOrder.map(item => {
                            const current = extractedItems.find(e => 
                                e.title === item.title && e.issue === item.issue
                            );
                            return current || item;
                        });
                    }
                    break;
            }
            
            showResults();
        }
        
        function showResults() {
            document.getElementById('bulkMode').style.display = 'none';
            document.getElementById('resultsMode').style.display = 'block';
            
            const total = extractedItems.reduce((sum, item) => sum + (item.selectedPrice || item.fair_value || item.value || 0), 0);
            const valued = extractedItems.filter(item => item.value).length;
            
            document.getElementById('totalValue').textContent = '$' + total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('itemCount').textContent = `${valued} item${valued !== 1 ? 's' : ''} valued`;
            
            document.getElementById('resultsList').innerHTML = extractedItems.map((item, idx) => {
                const quickSale = item.quick_sale || item.value * 0.85 || 0;
                const fairValue = item.fair_value || item.value || 0;
                const highEnd = item.high_end || item.value * 1.15 || 0;
                const selectedTier = item.selectedTier || 'fair';
                
                // Set default selected price if not set
                if (!item.selectedPrice) {
                    item.selectedPrice = fairValue;
                    item.selectedTier = 'fair';
                }
                
                return `
                <div class="item-card has-value">
                    <div class="item-header">
                        <span class="item-number">${idx + 1}</span>
                        <span class="item-title">${item.title} #${item.issue}${item.printing && item.printing !== '1st' ? ` (${item.printing} Print)` : ''}${item.cover ? ` Cover ${item.cover}` : ''}</span>
                        ${item.sales_data && item.sales_data.length > 0 ? `<button class="item-details-btn" onclick="toggleDetails(${idx})" title="View sales data">üìä</button>` : ''}
                    </div>
                    <div class="price-tiers">
                        <div class="price-tier ${selectedTier === 'quick' ? 'selected' : ''}" onclick="selectPriceTier(${idx}, 'quick', ${quickSale.toFixed(2)})">
                            <div class="price-tier-label">Quick Sale</div>
                            <div class="price-tier-value">$${quickSale.toFixed(2)}</div>
                        </div>
                        <div class="price-tier ${selectedTier === 'fair' ? 'selected' : ''}" onclick="selectPriceTier(${idx}, 'fair', ${fairValue.toFixed(2)})">
                            <div class="price-tier-label">Fair Value</div>
                            <div class="price-tier-value">$${fairValue.toFixed(2)}</div>
                        </div>
                        <div class="price-tier ${selectedTier === 'high' ? 'selected' : ''}" onclick="selectPriceTier(${idx}, 'high', ${highEnd.toFixed(2)})">
                            <div class="price-tier-label">High End</div>
                            <div class="price-tier-value">$${highEnd.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="price-tier-hint">Click a price to select it for listing</div>
                    <button class="list-btn" onclick="listItemOnEbay(${idx})" ${ebayConnected ? '' : 'disabled'}>
                        ${ebayConnected ? 'üõí List on eBay' : 'üîó Connect eBay to List'}
                    </button>
                    ${item.sales_data && item.sales_data.length > 0 ? `
                    <div class="sales-details" id="details-${idx}">
                        <h5>üìä Sales Data Used for Valuation</h5>
                        ${item.sales_data.map(sale => `
                            <div class="sale-item">
                                <div>
                                    <span class="sale-price">$${sale.price.toFixed(2)}</span>
                                    <span class="sale-meta"> ¬∑ ${sale.source || 'Unknown source'}</span>
                                    ${sale.grade ? `<span class="sale-meta"> ¬∑ Grade: ${sale.grade}</span>` : ''}
                                </div>
                                <div>
                                    <span class="sale-meta">${sale.date || 'Unknown date'}</span>
                                    ${sale.weight ? `<span class="sale-weight">${(sale.weight * 100).toFixed(0)}% weight</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
            `}).join('');
        }
        
        function selectPriceTier(idx, tier, price) {
            extractedItems[idx].selectedTier = tier;
            extractedItems[idx].selectedPrice = price;
            showResults(); // Re-render to update selection and total
        }
        
        function toggleDetails(idx) {
            const details = document.getElementById('details-' + idx);
            if (details) {
                details.classList.toggle('show');
            }
        }
        
        function downloadExcel() {
            const data = extractedItems.map(item => ({
                Title: item.title,
                Issue: item.issue,
                Publisher: item.publisher,
                Year: item.year,
                Grade: item.grade,
                Printing: item.printing || '1st',
                Cover: item.cover || '',
                Variant: item.variant || '',
                Edition: item.edition || '',
                Value: item.value || 0,
                Confidence: item.confidence || '',
                Source: item.source || '',
                Samples: item.samples ? item.samples.join(', ') : ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Collection');
            XLSX.writeFile(wb, 'CollectionCalc_Valuations.xlsx');
        }
        
        async function refreshItem(idx) {
            const item = extractedItems[idx];
            const samples = [];
            
            showThinking(`Refreshing: ${item.title} #${item.issue}`, [
                'Sample 1: Searching...',
                'Sample 2: Waiting...',
                'Sample 3: Waiting...',
                'Calculating average...',
                'Updating value...'
            ]);
            
            // Run 3 valuations
            for (let s = 0; s < 3; s++) {
                // Update step text
                document.getElementById('step' + (s + 1) + 'Text').textContent = `Sample ${s + 1}: Searching...`;
                document.getElementById('step' + (s + 1)).classList.remove('pending');
                document.getElementById('step' + (s + 1)).classList.add('active');
                
                try {
                    const result = await getValuation(item, true);  // Force refresh to bypass cache
                    samples.push(result.value);
                    
                    // Mark step done with value
                    document.getElementById('step' + (s + 1) + 'Text').textContent = `Sample ${s + 1}: $${result.value.toFixed(2)}`;
                    document.getElementById('step' + (s + 1)).classList.remove('active');
                    document.getElementById('step' + (s + 1)).classList.add('done');
                    
                } catch (error) {
                    document.getElementById('step' + (s + 1) + 'Text').textContent = `Sample ${s + 1}: Error`;
                    document.getElementById('step' + (s + 1)).classList.remove('active');
                    document.getElementById('step' + (s + 1)).classList.add('done');
                }
                
                // 60 second delay between samples (except after last)
                if (s < 2) {
                    for (let sec = 60; sec > 0; sec--) {
                        document.getElementById('step' + (s + 2) + 'Text').textContent = `Sample ${s + 2}: Waiting ${sec}s...`;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }
            
            // Calculate average
            document.getElementById('step4').classList.remove('pending');
            document.getElementById('step4').classList.add('active');
            document.getElementById('step4Text').textContent = 'Calculating average...';
            
            if (samples.length > 0) {
                const avgValue = samples.reduce((a, b) => a + b, 0) / samples.length;
                
                document.getElementById('step4').classList.remove('active');
                document.getElementById('step4').classList.add('done');
                document.getElementById('step4Text').textContent = `Average: $${avgValue.toFixed(2)}`;
                
                // Update item
                document.getElementById('step5').classList.remove('pending');
                document.getElementById('step5').classList.add('active');
                document.getElementById('step5Text').textContent = 'Updating value...';
                
                extractedItems[idx].value = avgValue;
                extractedItems[idx].samples = samples;
                extractedItems[idx].source = 'refreshed (3 samples)';
                extractedItems[idx].confidence = 'HIGH';
                
                // Save to database cache
                try {
                    await fetch(`${API_URL}/api/cache/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: item.title,
                            issue: item.issue,
                            value: avgValue,
                            samples: samples
                        })
                    });
                } catch (e) {
                    console.error('Failed to update cache:', e);
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                document.getElementById('step5').classList.remove('active');
                document.getElementById('step5').classList.add('done');
                document.getElementById('step5Text').textContent = `Updated: $${avgValue.toFixed(2)} (saved to database)`;
            }
            
            // Update displays
            setTimeout(() => {
                hideThinking();
                // Capture original order for "Order Added" sort
                originalOrder = extractedItems.map((item, idx) => ({ ...item, originalIndex: idx }));
                showResults();
            }, 1500);
        }
        
        function showThinking(title, steps) {
            document.getElementById('thinkingTitle').textContent = title;
            // Make all steps visible and reset them
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById('step' + i);
                step.style.display = 'flex';
                step.classList.remove('active', 'done');
                step.classList.add('pending');
                if (steps && steps[i-1]) {
                    document.getElementById('step' + i + 'Text').textContent = steps[i-1];
                }
            }
            document.getElementById('thinking').classList.add('show');
            animateThinking();
        }
        
        function hideThinking() {
            document.getElementById('thinking').classList.remove('show');
        }
        
        function animateThinking() {
            const delays = [0, 1500, 3000, 5000, 7000];
            delays.forEach((delay, index) => {
                setTimeout(() => {
                    if (index > 0) {
                        const prev = document.getElementById('step' + index);
                        prev.classList.remove('active');
                        prev.classList.add('done');
                    }
                    const el = document.getElementById('step' + (index + 1));
                    el.classList.remove('pending');
                    el.classList.add('active');
                }, delay);
            });
        }
        
        function showWaiting(completedTitle, value) {
            document.getElementById('thinkingTitle').textContent = '‚úì ' + completedTitle;
            // Mark all steps as done
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById('step' + i);
                step.classList.remove('active', 'pending');
                step.classList.add('done');
            }
            // Update step text to show result and countdown
            document.getElementById('step1Text').textContent = value ? `Valued at $${value.toFixed(2)}` : 'Valuation complete';
            document.getElementById('step2Text').textContent = '';
            document.getElementById('step3Text').textContent = 'Waiting for rate limit...';
            document.getElementById('step4Text').textContent = '';
            document.getElementById('step5Text').textContent = '';
            // Hide steps 2, 4, 5
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step4').style.display = 'none';
            document.getElementById('step5').style.display = 'none';
        }
        
        function updateWaitingCountdown(seconds, nextItem) {
            document.getElementById('step3Text').textContent = `Next: ${nextItem.title} #${nextItem.issue} in ${seconds}s`;
            document.getElementById('step3').classList.remove('done');
            document.getElementById('step3').classList.add('active');
        }
        
        function resetThinkingSteps() {
            // Make all steps visible again
            for (let i = 1; i <= 5; i++) {
                document.getElementById('step' + i).style.display = 'flex';
            }
        }
        
        // Manual form submission
        document.getElementById('valuationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                title: document.getElementById('title').value,
                issue: document.getElementById('issue').value,
                year: null,
                publisher: null,
                grade: document.getElementById('grade').value
            };
            
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Calculating...';
            showThinking('Calculating value...', [
                'Checking database for matches',
                'Searching market data',
                'Crunching the numbers',
                'Calculating confidence score',
                'Generating valuation'
            ]);
            
            try {
                const response = await fetch(`${API_URL}/api/valuate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const json = await response.json();
                if (json.error) throw new Error(json.error);
                
                const resultCard = document.getElementById('resultCard');
                const resultContent = document.getElementById('resultContent');
                resultCard.classList.remove('error');
                
                let confClass = 'medium';
                if (json.confidence === 'HIGH') confClass = 'high';
                else if (json.confidence === 'MEDIUM-HIGH') confClass = 'medium-high';
                else if (json.confidence === 'LOW') confClass = 'low';
                
                let sourceText = json.source || 'estimate';
                if (sourceText === 'ebay') sourceText = 'üìä Market Data';
                else if (sourceText === 'database') sourceText = 'üìÅ Database';
                
                const formatPrice = (val) => val ? val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '‚Äî';
                
                const quickSale = json.quick_sale || (json.final_value * 0.7);
                const fairValue = json.fair_value || json.final_value;
                const highEnd = json.high_end || (json.final_value * 1.3);
                
                // Get tier confidences (fallback to overall confidence)
                const quickSaleConf = json.quick_sale_confidence || json.confidence_score || 50;
                const fairValueConf = json.fair_value_confidence || json.confidence_score || 50;
                const highEndConf = json.high_end_confidence || json.confidence_score || 50;
                
                // Helper to get confidence label
                const getConfLabel = (score) => {
                    if (score >= 70) return 'High';
                    if (score >= 50) return 'Medium';
                    if (score >= 30) return 'Low';
                    return 'Very Low';
                };
                
                // Build details section content
                const salesCount = json.ebay_sales || 0;
                const priceRange = json.ebay_price_range ? `$${formatPrice(json.ebay_price_range[0])} - $${formatPrice(json.ebay_price_range[1])}` : '‚Äî';
                
                resultContent.innerHTML = `
                    <p class="result-label">Value Range</p>
                    <div class="price-tiers">
                        <div class="tier quick-sale">
                            <span class="tier-label">Quick Sale</span>
                            <span class="tier-price">$${formatPrice(quickSale)}</span>
                            <span class="tier-desc">Sell fast</span>
                        </div>
                        <div class="tier fair-value">
                            <span class="tier-label">Fair Value</span>
                            <span class="tier-price">$${formatPrice(fairValue)}</span>
                            <span class="tier-desc">Market median</span>
                        </div>
                        <div class="tier high-end">
                            <span class="tier-label">High End</span>
                            <span class="tier-price">$${formatPrice(highEnd)}</span>
                            <span class="tier-desc">Premium price</span>
                        </div>
                    </div>
                    <button class="details-toggle" onclick="this.classList.toggle('active'); this.nextElementSibling.classList.toggle('show');">
                        Details
                    </button>
                    <div class="details-section">
                        <div class="stat-row">
                            <span class="stat-label">Recent Sales</span>
                            <span class="stat-value">${salesCount}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Price Range</span>
                            <span class="stat-value">${priceRange}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Data Source</span>
                            <span class="stat-value">${sourceText}</span>
                        </div>
                        <h4 style="margin-top: 15px;">Confidence</h4>
                        <div class="stat-row">
                            <span class="stat-label">Quick Sale</span>
                            <span class="stat-value">${getConfLabel(quickSaleConf)} (${quickSaleConf}%)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Fair Value</span>
                            <span class="stat-value">${getConfLabel(fairValueConf)} (${fairValueConf}%)</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">High End</span>
                            <span class="stat-value">${getConfLabel(highEndConf)} (${highEndConf}%)</span>
                        </div>
                        <h4 style="margin-top: 15px;">Analysis</h4>
                        <p>${json.reasoning || 'No additional details'}</p>
                    </div>
                    <div class="ebay-section" id="ebaySection"></div>
                `;
                
                // Update eBay section based on connection status
                updateEbayUI();
                
                // Store current comic info for listing
                window.currentComic = {
                    title: data.title,
                    issue: data.issue,
                    quickSale: quickSale,
                    fairValue: fairValue,
                    highEnd: highEnd
                };
                
                // If connected, show list buttons
                if (ebayConnected) {
                    const escTitle = data.title.replace(/'/g, "\\'");
                    const escIssue = data.issue.replace(/'/g, "\\'");
                    document.getElementById('listButtons').innerHTML = `
                        <button class="list-btn" onclick="listOnEbay('${escTitle}', '${escIssue}', ${quickSale}, 'Quick Sale')">
                            List at $${formatPrice(quickSale)}
                        </button>
                        <button class="list-btn" onclick="listOnEbay('${escTitle}', '${escIssue}', ${fairValue}, 'Fair Value')">
                            List at $${formatPrice(fairValue)}
                        </button>
                        <button class="list-btn" onclick="listOnEbay('${escTitle}', '${escIssue}', ${highEnd}, 'High End')">
                            List at $${formatPrice(highEnd)}
                        </button>
                    `;
                }
                
                document.getElementById('result').classList.add('show');
                
            } catch (error) {
                document.getElementById('resultCard').classList.add('error');
                document.getElementById('resultContent').innerHTML = `<p class="result-label">Error</p><div class="price">${error.message}</div>`;
                document.getElementById('result').classList.add('show');
            }
            
            hideThinking();
            btn.disabled = false;
            btn.textContent = 'Get Valuation';
        });
    </script>
</body>
</html>
