<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slab Worthy&trade; - AI Comic Grading</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script>
        // Auth gate ‚Äî redirect to login if not authenticated
        (function() {
            const token = localStorage.getItem('cc_token');
            if (!token) {
                window.location.replace('/login.html');
            }
        })();
    </script>
    <style>
        /* Gold Bangers logo for app header */
        .header-brand h1 {
            font-family: 'Bangers', cursive !important;
            font-size: clamp(1.8rem, 5vw, 2.5rem) !important;
            letter-spacing: 2px !important;
            color: #facc15 !important;
            -webkit-text-fill-color: #facc15 !important;
            background: none !important;
            -webkit-background-clip: unset !important;
            background-clip: unset !important;
            text-shadow: 1px 1px 0 #7c3aed, 2px 2px 0 #1e1b4b !important;
            margin: 0;
            line-height: 1.1;
        }
        .header-brand .subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 0.75rem;
            margin-top: 2px;
        }

        /* Hide Take Photo button on desktop - only show on mobile */
        @media (min-width: 768px) {
            .photo-option-btn.camera {
                display: none !important;
            }
            .mobile-only {
                display: none !important;
            }
        }
        @media (max-width: 767px) {
            .desktop-only {
                display: none !important;
            }
        }
        
        /* Comic-shaped upload boxes */
        #gradingUpload1, #gradingUpload3 {
            /* Front & Back Cover - 7:10 comic ratio */
            aspect-ratio: 7 / 10;
            max-width: 280px;
            margin: 0 auto;
        }
        #gradingUpload2 {
            /* Spine - narrow and tall */
            aspect-ratio: 1 / 6;
            max-width: 80px;
            margin: 0 auto;
        }
        #gradingUpload4 {
            /* Centerfold - open book landscape */
            aspect-ratio: 14 / 10;
            max-width: 450px;
            margin: 0 auto;
            position: relative;
        }
        #gradingUpload4::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 10%;
            height: 80%;
            border-left: 2px dashed rgba(99, 102, 241, 0.4);
            pointer-events: none;
            z-index: 1;
        }
        
        /* Adjust button layout for narrow spine */
        #gradingUpload2 .photo-option-btn {
            padding: 8px 4px;
            font-size: 12px;
        }
        #gradingUpload2 .photo-option-icon {
            font-size: 1.2rem;
        }
        #gradingUpload2 .photo-option-text {
            display: none;
        }
        
        /* Photo diagram container */
        .photo-diagram-container {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        /* Photo diagram grid */
        .photo-diagram {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        /* Top row: Front, Spine, Back */
        .photo-diagram-row-top {
            display: flex;
            gap: 4px;
            align-items: flex-end;
        }

        /* Bottom row: Centerfold (centered) */
        .photo-diagram-row-bottom {
            display: flex;
            justify-content: center;
        }

        /* Individual photo boxes */
        .photo-box {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(168, 85, 247, 0.4);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
            font-size: 8px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        /* Front and Back - tall rectangles (7:10 ratio) */
        .photo-front,
        .photo-back {
            width: 38px;
            height: 54px;
        }

        /* Spine - narrow strip */
        .photo-spine {
            width: 12px;
            height: 54px;
            font-size: 6px;
            line-height: 1;
            padding: 2px 0;
            letter-spacing: 0;
            word-break: break-all;
        }

        /* Centerfold - wider horizontal */
        .photo-centerfold {
            width: 76px;
            height: 54px;
        }

        /* Active state - highlighted box */
        .photo-box.active {
            border-color: rgb(168, 85, 247);
            background: rgba(168, 85, 247, 0.2);
            color: rgb(168, 85, 247);
            box-shadow: 0 0 12px rgba(168, 85, 247, 0.4);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Pulse animation for active box */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 12px rgba(168, 85, 247, 0.4);
            }
            50% {
                box-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
            }
        }

        /* Diagram label */
        .photo-diagram-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        /* Mobile adjustments for photo diagram */
        @media (max-width: 767px) {
            .photo-diagram {
                padding: 0.75rem;
            }
            
            .photo-front,
            .photo-back {
                width: 32px;
                height: 46px;
            }
            
            .photo-spine {
                width: 10px;
                height: 46px;
                font-size: 5px;
            }
            
            .photo-centerfold {
                width: 64px;
                height: 46px;
            }
            
            .photo-box {
                font-size: 7px;
            }
            
            .photo-diagram-label {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-brand">
                <h1>SLAB WORTHY<span style="font-size: 0.6em; vertical-align: super;">‚Ñ¢</span></h1>
                <p class="subtitle">AI for Comic Collectors</p>
            </div>
            <div class="header-auth" id="headerAuth">
                <!-- Logged out state -->
                <div id="authLoggedOut">
                    <button class="auth-btn auth-btn-login" onclick="openAuthModal('login')">Log In</button>
                    <button class="auth-btn auth-btn-signup" onclick="openAuthModal('signup')">Sign Up</button>
                </div>
                <!-- Logged in state -->
                <div id="authLoggedIn" style="display: none;">
                    <button class="save-collection-btn" onclick="showCollection()" title="My Collection">
                        üìö My Collection
                    </button>
                    <div class="user-menu">
                        <button class="user-menu-btn" onclick="toggleUserMenu()">
                            <div class="user-avatar" id="userAvatar">?</div>
                            <span id="userEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2f5a5c4a5d6f4a574e425f434a014c4042">[email&#160;protected]</a></span>
                            <span>‚ñæ</span>
                        </button>
                        <div class="user-menu-dropdown" id="userMenuDropdown">
                            <button class="user-menu-item" onclick="showCollection()">üìö My Collection</button>
                            <button class="user-menu-item admin-only" id="adminMenuItem" onclick="window.location.href='/admin.html'" style="display:none;">üîß Admin</button>
                            <div class="user-menu-divider"></div>
                            <button class="user-menu-item danger" onclick="logout()">Log Out</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div id="mainApp">
            <div class="mode-toggle" style="display: none;">
                <button class="mode-btn active" id="modeGrading" onclick="setMode('grading')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-right: 4px;"><rect x="3" y="1" width="18" height="22" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><rect x="6" y="4" width="12" height="13" rx="1" fill="rgba(99, 102, 241, 0.15)" stroke="currentColor" stroke-width="1"/><text x="12" y="14" text-anchor="middle" fill="currentColor" font-size="10" font-weight="bold" font-family="Arial">?</text><rect x="6" y="18" width="12" height="3" rx="0.5" fill="currentColor"/></svg> Slab Worthy&trade;?</button>
                <button class="mode-btn" id="modeManual" onclick="setMode('manual')">‚úèÔ∏è Manual Entry</button>
            </div>
            
            <div class="card">
                <!-- Manual Entry Mode -->
                <div id="manualMode" style="display: none;">
                    <form id="valuationForm">
                        <div class="form-group">
                            <label for="title">Comic Title</label>
                            <input type="text" id="title" placeholder="e.g. Amazing Spider-Man (or ASM)" required>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label for="issue">Issue #</label>
                                <input type="text" id="issue" placeholder="e.g. 300" required>
                            </div>
                            <div class="form-group">
                                <label for="grade">Grade</label>
                                <select id="grade">
                                    <option value="NM">Near Mint (NM)</option>
                                    <option value="VF" selected>Very Fine (VF)</option>
                                    <option value="FN">Fine (FN)</option>
                                    <option value="VG">Very Good (VG)</option>
                                    <option value="G">Good (G)</option>
                                    <option value="FR">Fair (FR)</option>
                                    <option value="PR">Poor (PR)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" id="submitBtn">Get Valuation</button>
                    </form>
                </div>
                
                <!-- Photo Upload Mode -->
                <div id="photoMode" style="display: none;">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click();">
                        <input type="file" id="photoInput" class="upload-input" accept=".jpg,.jpeg,.png,.webp,.heic" multiple onchange="handlePhotoUpload(this.files)">
                        <div class="upload-icon">üì∏</div>
                        <div class="upload-title">Click to upload or drag & drop</div>
                        <div class="upload-subtitle">Select one or multiple comic photos</div>
                    </div>
                </div>
                
                <!-- ========================================== -->
                <!-- GRADE MY COMIC MODE - DEFAULT -->
                <!-- ========================================== -->
                <div id="gradingMode">
                    
                    <!-- Progress Steps Indicator -->
                    <div class="grading-progress">
                        <div class="grading-step active" id="gradingStep1">
                            <div class="step-number">1</div>
                            <div class="step-label">Front</div>
                        </div>
                        <div class="grading-step-line"></div>
                        <div class="grading-step" id="gradingStep2">
                            <div class="step-number">2</div>
                            <div class="step-label">Spine</div>
                        </div>
                        <div class="grading-step-line"></div>
                        <div class="grading-step" id="gradingStep3">
                            <div class="step-number">3</div>
                            <div class="step-label">Back</div>
                        </div>
                        <div class="grading-step-line"></div>
                        <div class="grading-step" id="gradingStep4">
                            <div class="step-number">4</div>
                            <div class="step-label">Center</div>
                        </div>
                        <div class="grading-step-line"></div>
                        <div class="grading-step" id="gradingStep5">
                            <div class="step-number">5</div>
                            <div class="step-label">Report</div>
                        </div>
                    </div>
                    
                    <!-- Step 1: Front Cover (Required) -->
                    <div class="grading-step-content active" id="gradingContent1">
                        <div class="grading-header">
                            <h3>üì∑ Step 1: Front Cover</h3>
                            <span class="grading-required">Required</span>
                        </div>
                        <p class="grading-instruction"><span class="mobile-only">Take</span><span class="desktop-only">Upload</span> a clear, upright photo of the front cover. This identifies your comic and assesses cover condition.</p>
                        
                        <div class="grading-photo-options" id="gradingUpload1">
                            <input type="file" id="gradingCamera1" class="upload-input" accept="image/*" capture="environment" onchange="handleGradingPhoto(1, this.files)">
                            <input type="file" id="gradingGallery1" class="upload-input" accept="*/*" onchange="handleGradingPhoto(1, this.files)">
                            <button type="button" class="photo-option-btn camera" onclick="document.getElementById('gradingCamera1').click();">
                                <span class="photo-option-icon">üì∑</span>
                                <span class="photo-option-text">Take Photo</span>
                            </button>
                            <button type="button" class="photo-option-btn gallery" onclick="document.getElementById('gradingGallery1').click();">
                                <span class="photo-option-icon">üìÅ</span>
                                <span class="photo-option-text">Upload</span>
                            </button>
                            <div class="photo-diagram-container">
                                <div class="photo-diagram">
                                    <div class="photo-diagram-row-top">
                                        <div class="photo-box photo-front active">Front</div>
                                        <div class="photo-box photo-spine">S<br>p<br>i<br>n<br>e</div>
                                        <div class="photo-box photo-back">Back</div>
                                    </div>
                                    <div class="photo-diagram-row-bottom">
                                        <div class="photo-box photo-centerfold">Centerfold</div>
                                    </div>
                                </div>
                                <div class="photo-diagram-label">FRONT COVER - Full cover visible, good lighting</div>
                            </div>
                        </div>
                        
                        <!-- Preview after photo taken -->
                        <div class="grading-preview" id="gradingPreview1" style="display: none;">
                            <img id="gradingImg1" src="" alt="Front cover">
                            <div class="grading-preview-info" id="gradingInfo1">
                                <!-- Populated after extraction -->
                            </div>
                            <div class="grading-preview-actions">
                                <button type="button" class="btn-secondary btn-small" onclick="retakeGradingPhoto(1)">üîÑ Retake</button>
                            </div>
                        </div>
                        
                        <!-- Quality feedback -->
                        <div class="grading-feedback" id="gradingFeedback1" style="display: none;">
                            <span class="feedback-icon">‚ö†Ô∏è</span>
                            <span class="feedback-text" id="gradingFeedbackText1"></span>
                        </div>
                        
                        <div class="grading-tips">
                            <button type="button" class="tips-toggle" onclick="togglePhotoTips()">üí° Photo tips</button>
                        </div>
                        
                        <div class="grading-actions">
                            <button type="button" class="btn-primary" id="gradingNext1" onclick="nextGradingStep(1)" disabled>Continue to Spine ‚Üí</button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Spine -->
                    <div class="grading-step-content" id="gradingContent2">
                        <div class="grading-header">
                            <h3>üì∑ Step 2: Spine</h3>
                            <span class="grading-optional">Recommended</span>
                        </div>
                        <p class="grading-instruction"><span class="mobile-only">Photograph</span><span class="desktop-only">Upload a photo of</span> the spine to check for stress marks, rolls, and breaks.</p>
                        
                        <div class="grading-comic-id" id="gradingComicId2">
                            <!-- Shows detected comic from step 1 -->
                        </div>
                        
                        <div class="grading-photo-options" id="gradingUpload2">
                            <input type="file" id="gradingCamera2" class="upload-input" accept="image/*" capture="environment" onchange="handleGradingPhoto(2, this.files)">
                            <input type="file" id="gradingGallery2" class="upload-input" accept="*/*" onchange="handleGradingPhoto(2, this.files)">
                            <button type="button" class="photo-option-btn camera" onclick="document.getElementById('gradingCamera2').click();">
                                <span class="photo-option-icon">üì∑</span>
                                <span class="photo-option-text">Take Photo</span>
                            </button>
                            <button type="button" class="photo-option-btn gallery" onclick="document.getElementById('gradingGallery2').click();">
                                <span class="photo-option-icon">üìÅ</span>
                                <span class="photo-option-text">Upload</span>
                            </button>
                            <div class="photo-diagram-container">
                                <div class="photo-diagram">
                                    <div class="photo-diagram-row-top">
                                        <div class="photo-box photo-front">Front</div>
                                        <div class="photo-box photo-spine active">S<br>p<br>i<br>n<br>e</div>
                                        <div class="photo-box photo-back">Back</div>
                                    </div>
                                    <div class="photo-diagram-row-bottom">
                                        <div class="photo-box photo-centerfold">Centerfold</div>
                                    </div>
                                </div>
                                <div class="photo-diagram-label">SPINE - Hold comic sideways so spine fills frame</div>
                            </div>
                        </div>
                        
                        <div class="grading-preview" id="gradingPreview2" style="display: none;">
                            <img id="gradingImg2" src="" alt="Spine">
                            <div class="grading-preview-info" id="gradingInfo2"></div>
                            <div class="grading-preview-actions">
                                <button type="button" class="btn-secondary btn-small" onclick="retakeGradingPhoto(2)">üîÑ Retake</button>
                            </div>
                        </div>
                        
                        <div class="grading-feedback" id="gradingFeedback2" style="display: none;">
                            <span class="feedback-icon">‚ö†Ô∏è</span>
                            <span class="feedback-text" id="gradingFeedbackText2"></span>
                        </div>
                        
                        <div class="grading-actions">
                            <button type="button" class="btn-secondary" onclick="skipGradingStep(2)">Skip</button>
                            <button type="button" class="btn-primary" id="gradingNext2" onclick="nextGradingStep(2)" disabled>Continue to Back ‚Üí</button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Back Cover -->
                    <div class="grading-step-content" id="gradingContent3">
                        <div class="grading-header">
                            <h3>üì∑ Step 3: Back Cover</h3>
                            <span class="grading-optional">Recommended</span>
                        </div>
                        <p class="grading-instruction"><span class="mobile-only">Photograph</span><span class="desktop-only">Upload a photo of</span> the back cover to check for damage not visible from front.</p>
                        
                        <div class="grading-comic-id" id="gradingComicId3"></div>
                        
                        <div class="grading-photo-options" id="gradingUpload3">
                            <input type="file" id="gradingCamera3" class="upload-input" accept="image/*" capture="environment" onchange="handleGradingPhoto(3, this.files)">
                            <input type="file" id="gradingGallery3" class="upload-input" accept="*/*" onchange="handleGradingPhoto(3, this.files)">
                            <button type="button" class="photo-option-btn camera" onclick="document.getElementById('gradingCamera3').click();">
                                <span class="photo-option-icon">üì∑</span>
                                <span class="photo-option-text">Take Photo</span>
                            </button>
                            <button type="button" class="photo-option-btn gallery" onclick="document.getElementById('gradingGallery3').click();">
                                <span class="photo-option-icon">üìÅ</span>
                                <span class="photo-option-text">Upload</span>
                            </button>
                            <div class="photo-diagram-container">
                                <div class="photo-diagram">
                                    <div class="photo-diagram-row-top">
                                        <div class="photo-box photo-front">Front</div>
                                        <div class="photo-box photo-spine">S<br>p<br>i<br>n<br>e</div>
                                        <div class="photo-box photo-back active">Back</div>
                                    </div>
                                    <div class="photo-diagram-row-bottom">
                                        <div class="photo-box photo-centerfold">Centerfold</div>
                                    </div>
                                </div>
                                <div class="photo-diagram-label">BACK COVER - Full back cover visible</div>
                            </div>
                        </div>
                        
                        <div class="grading-preview" id="gradingPreview3" style="display: none;">
                            <img id="gradingImg3" src="" alt="Back cover">
                            <div class="grading-preview-info" id="gradingInfo3"></div>
                            <div class="grading-preview-actions">
                                <button type="button" class="btn-secondary btn-small" onclick="retakeGradingPhoto(3)">üîÑ Retake</button>
                            </div>
                        </div>
                        
                        <div class="grading-feedback" id="gradingFeedback3" style="display: none;">
                            <span class="feedback-icon">‚ö†Ô∏è</span>
                            <span class="feedback-text" id="gradingFeedbackText3"></span>
                        </div>
                        
                        <div class="grading-actions">
                            <button type="button" class="btn-secondary" onclick="skipGradingStep(3)">Skip</button>
                            <button type="button" class="btn-primary" id="gradingNext3" onclick="nextGradingStep(3)" disabled>Continue to Centerfold ‚Üí</button>
                        </div>
                    </div>
                    
                    <!-- Step 4: Centerfold/Staples -->
                    <div class="grading-step-content" id="gradingContent4">
                        <div class="grading-header">
                            <h3>üì∑ Step 4: Centerfold & Staples</h3>
                            <span class="grading-optional">Recommended</span>
                        </div>
                        <p class="grading-instruction">Open to the center and <span class="mobile-only">photograph</span><span class="desktop-only">upload a photo of</span> the staples and centerfold attachment.</p>
                        
                        <div class="grading-comic-id" id="gradingComicId4"></div>
                        
                        <div class="grading-photo-options" id="gradingUpload4">
                            <input type="file" id="gradingCamera4" class="upload-input" accept="image/*" capture="environment" onchange="handleGradingPhoto(4, this.files)">
                            <input type="file" id="gradingGallery4" class="upload-input" accept="*/*" onchange="handleGradingPhoto(4, this.files)">
                            <button type="button" class="photo-option-btn camera" onclick="document.getElementById('gradingCamera4').click();">
                                <span class="photo-option-icon">üì∑</span>
                                <span class="photo-option-text">Take Photo</span>
                            </button>
                            <button type="button" class="photo-option-btn gallery" onclick="document.getElementById('gradingGallery4').click();">
                                <span class="photo-option-icon">üìÅ</span>
                                <span class="photo-option-text">Upload</span>
                            </button>
                            <div class="photo-diagram-container">
                                <div class="photo-diagram">
                                    <div class="photo-diagram-row-top">
                                        <div class="photo-box photo-front">Front</div>
                                        <div class="photo-box photo-spine">S<br>p<br>i<br>n<br>e</div>
                                        <div class="photo-box photo-back">Back</div>
                                    </div>
                                    <div class="photo-diagram-row-bottom">
                                        <div class="photo-box photo-centerfold active">Centerfold</div>
                                    </div>
                                </div>
                                <div class="photo-diagram-label">CENTERFOLD - Open comic to center, show staples</div>
                            </div>
                        </div>
                        
                        <div class="grading-preview" id="gradingPreview4" style="display: none;">
                            <img id="gradingImg4" src="" alt="Centerfold">
                            <div class="grading-preview-info" id="gradingInfo4"></div>
                            <div class="grading-preview-actions">
                                <button type="button" class="btn-secondary btn-small" onclick="retakeGradingPhoto(4)">üîÑ Retake</button>
                            </div>
                        </div>
                        
                        <div class="grading-feedback" id="gradingFeedback4" style="display: none;">
                            <span class="feedback-icon">‚ö†Ô∏è</span>
                            <span class="feedback-text" id="gradingFeedbackText4"></span>
                        </div>
                        
                        <!-- Additional Photos Section -->
                        <div class="grading-additional">
                            <h4>üì∑ Additional Photos (Optional)</h4>
                            <p>Add photos of specific defects, torn pages, or other issues.</p>
                            <div class="additional-photos" id="additionalPhotos">
                                <!-- Thumbnails of additional photos appear here -->
                            </div>
                            <button type="button" class="btn-secondary btn-small" onclick="document.getElementById('additionalPhotoInput').click();">
                                + Add Photo
                            </button>
                            <input type="file" id="additionalPhotoInput" class="upload-input" accept=".jpg,.jpeg,.png,.webp,.heic" onchange="handleAdditionalPhoto(this.files)">
                        </div>
                        
                        <div class="grading-actions">
                            <button type="button" class="btn-secondary" onclick="skipGradingStep(4)">Skip</button>
                            <button type="button" class="btn-primary" id="gradingNext4" onclick="generateGradeReport()">Generate Slab Report ‚Üí</button>
                        </div>
                    </div>
                    
                    <!-- Step 5: Grade Report -->
                    <div class="grading-step-content" id="gradingContent5">
                        <div class="grading-header">
                            <h3>üìã Slab Report</h3>
                            <span class="grading-patent">Patent Pending</span>
                        </div>
                        
                        <!-- Comic Identification -->
                        <div class="grade-report-comic" id="gradeReportComic">
                            <!-- Title, issue, publisher, year -->
                        </div>
                        
                        <!-- Grade Result -->
                        <div class="grade-report-result" id="gradeReportResult">
                            <div class="grade-big" id="gradeResultBig">--</div>
                            <div class="grade-label" id="gradeResultLabel">Analyzing...</div>
                            <div class="grade-quality-warning" id="gradeQualityWarning" style="display: none;">
                                <span class="warning-icon">‚ö†Ô∏è</span>
                                <span class="warning-text">Grade based on limited photos. Add spine, back, and centerfold for higher confidence.</span>
                            </div>
                            <div class="grade-photos-used" id="gradePhotosUsed">
                                <!-- Shows which photos were analyzed -->
                            </div>
                        </div>
                        
                        <!-- Defects Found -->
                        <div class="grade-report-defects" id="gradeReportDefects">
                            <h4>Defects Found</h4>
                            <div class="defects-list" id="defectsList">
                                <!-- Defects by area -->
                            </div>
                        </div>
                        
                        <!-- Should You Grade? -->
                        <div class="grade-report-recommendation" id="gradeReportRecommendation">
                            <h4><svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-right: 4px;"><rect x="3" y="1" width="18" height="22" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><rect x="6" y="4" width="12" height="13" rx="1" fill="rgba(99, 102, 241, 0.15)" stroke="currentColor" stroke-width="1"/><text x="12" y="14" text-anchor="middle" fill="currentColor" font-size="10" font-weight="bold" font-family="Arial">?</text><rect x="6" y="18" width="12" height="3" rx="0.5" fill="currentColor"/></svg> Should You Slab It?</h4>
                            <div class="recommendation-values" id="recommendationValues">
                                <!-- Market values and calculation -->
                            </div>
                            <div class="recommendation-verdict" id="recommendationVerdict">
                                <!-- SUBMIT / KEEP RAW recommendation -->
                            </div>
                        </div>
                        
                        <!-- Signature Detection (if found) -->
                        <div class="grade-report-signature" id="gradeReportSignature" style="display: none;">
                            <h4>‚úçÔ∏è Signature Detected</h4>
                            <div id="signatureInfo">
                                <!-- Signature analysis -->
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="grading-actions">
                            <button type="button" class="btn-secondary" onclick="resetGrading()">‚Üê Grade Another</button>
                            <button type="button" class="btn-primary" onclick="saveGradeToCollection()">üíæ Save to Collection</button>
                        </div>
                    </div>
                    
                </div>
                <!-- END GRADE MY COMIC MODE -->
                
                <!-- Bulk Extracted Items -->
                <div id="bulkMode" style="display: none;">
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progressText">Calculating...</div>
                    </div>
                    
                    <div id="itemsList"></div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn-secondary" onclick="resetToPhoto()">‚Üê Add More Photos</button>
                        <button type="button" id="valuateAllBtn" onclick="valuateAll()">Get All Valuations</button>
                    </div>
                </div>
                
                <!-- Results Summary (for bulk) -->
                <div id="resultsMode" style="display: none;">
                    <div class="summary-card">
                        <div class="result-label">Total Collection Value</div>
                        <div class="summary-total" id="totalValue">$0.00</div>
                        <div class="summary-count" id="itemCount">0 items valued</div>
                    </div>
                    
                    <div class="sort-controls">
                        <label for="sortSelect">Sort by:</label>
                        <select id="sortSelect" onchange="sortResults(this.value)">
                            <option value="default">Order Added</option>
                            <option value="value-high">Value (High to Low)</option>
                            <option value="value-low">Value (Low to High)</option>
                            <option value="title">Title (A-Z)</option>
                        </select>
                    </div>
                    
                    <div id="resultsList"></div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn-secondary" onclick="resetApp()">‚Üê Start Over</button>
                        <button type="button" onclick="downloadExcel()">üì• Download Excel</button>
                        <button type="button" class="save-collection-btn" onclick="saveAllToCollection()" id="saveCollectionBtn">
                            üíæ Save to Collection
                        </button>
                    </div>
                </div>
                
                <!-- Single Result (for manual entry) -->
                <div class="result" id="result">
                    <div class="result-card" id="resultCard">
                        <div id="resultContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- Thinking Indicator -->
            <div class="thinking-indicator" id="thinkingIndicator" style="display: none;">
                <div class="thinking-header">
                    <div class="thinking-calc">
                        <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Calculator body -->
                            <rect x="4" y="2" width="24" height="28" rx="3" stroke="url(#calcGrad)" stroke-width="2.5" fill="var(--bg-card)"/>
                            <!-- Display -->
                            <rect x="7" y="5" width="18" height="7" rx="1" fill="var(--bg-primary)" stroke="var(--brand-indigo)" stroke-width="1"/>
                            <text x="9" y="10.5" class="calc-display">$---</text>
                            <!-- Buttons row 1 -->
                            <rect class="calc-btn1" x="7" y="15" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect class="calc-btn2" x="14" y="15" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect class="calc-btn3" x="21" y="15" width="4" height="3" rx="0.5" fill="var(--brand-purple)"/>
                            <!-- Buttons row 2 -->
                            <rect class="calc-btn4" x="7" y="20" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect class="calc-btn5" x="14" y="20" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect class="calc-btn6" x="21" y="20" width="4" height="3" rx="0.5" fill="var(--brand-cyan)"/>
                            <!-- Buttons row 3 -->
                            <rect x="7" y="25" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect x="14" y="25" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect x="21" y="25" width="4" height="3" rx="0.5" fill="var(--status-success)"/>
                            <defs>
                                <linearGradient id="calcGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="var(--brand-indigo)"/>
                                    <stop offset="100%" stop-color="var(--brand-purple)"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <span class="thinking-title" id="thinkingTitle">Calculating...</span>
                </div>
                <div class="thinking-steps">
                    <div class="thinking-step pending" id="step1"><span class="icon"></span><span id="step1Text">Checking database for matches</span></div>
                    <div class="thinking-step pending" id="step2"><span class="icon"></span><span id="step2Text">Searching market data</span></div>
                    <div class="thinking-step pending" id="step3"><span class="icon"></span><span id="step3Text">Crunching the numbers</span></div>
                    <div class="thinking-step pending" id="step4"><span class="icon"></span><span id="step4Text">Calculating confidence score</span></div>
                    <div class="thinking-step pending" id="step5"><span class="icon"></span><span id="step5Text">Generating valuation</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Photo Tips Modal -->
    <div class="tips-modal-overlay" id="photoTipsModal">
        <div class="tips-modal">
            <div class="tips-modal-header">
                <h3>üì∏ How to Take Great Comic Photos</h3>
                <button class="tips-modal-close" onclick="closePhotoTips()">&times;</button>
            </div>
            <div class="tips-modal-body">
                <div class="tips-section">
                    <h4>üîÜ Lighting</h4>
                    <ul>
                        <li><strong>Do:</strong> Use natural light or bright, even lighting</li>
                        <li><strong>Don't:</strong> Use flash (causes glare) or dim lighting</li>
                    </ul>
                </div>
                <div class="tips-section">
                    <h4>üìê Angle</h4>
                    <ul>
                        <li><strong>Do:</strong> Shoot straight on, perpendicular to the comic</li>
                        <li><strong>Don't:</strong> Shoot at an angle (distorts proportions)</li>
                    </ul>
                </div>
                <div class="tips-section">
                    <h4>üîç Focus</h4>
                    <ul>
                        <li><strong>Do:</strong> Tap to focus, hold steady, ensure sharp image</li>
                        <li><strong>Don't:</strong> Move while shooting (causes blur)</li>
                    </ul>
                </div>
                <div class="tips-section">
                    <h4>üìè Framing</h4>
                    <ul>
                        <li><strong>Do:</strong> Include entire cover/spine with small margin</li>
                        <li><strong>Don't:</strong> Cut off edges or get too close</li>
                    </ul>
                </div>
                <div class="tips-section">
                    <h4>üéØ By Photo Type</h4>
                    <ul>
                        <li><strong>Front Cover:</strong> Full cover, all corners visible</li>
                        <li><strong>Spine:</strong> Turn comic sideways, spine fills frame vertically</li>
                        <li><strong>Back Cover:</strong> Same as front, full cover visible</li>
                        <li><strong>Centerfold:</strong> Open flat, show both staples clearly</li>
                    </ul>
                </div>
            </div>
            <div class="tips-modal-footer">
                <button class="btn-primary" onclick="closePhotoTips()">Got it!</button>
            </div>
        </div>
    </div>
    
    <!-- Auth Modal -->
    <div class="auth-modal-overlay" id="authModal">
        <div class="auth-modal">
            <button class="auth-modal-close" onclick="closeAuthModal()">&times;</button>
            <div class="auth-modal-header">
                <h2 id="authModalTitle">Welcome Back</h2>
                <p id="authModalSubtitle">Log in to save your collection</p>
            </div>
            <div class="auth-modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">Log In</button>
                    <button class="auth-tab" id="tabSignup" onclick="switchAuthTab('signup')">Sign Up</button>
                </div>
                
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                
                <!-- Login Form -->
                <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" id="loginBtn">Log In</button>
                    <div class="auth-footer">
                        <button type="button" class="auth-link" onclick="showForgotPassword()">Forgot password?</button>
                    </div>
                </form>
                
                <!-- Signup Form -->
                <form class="auth-form" id="signupForm" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="At least 8 characters" minlength="8" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPasswordConfirm">Confirm Password</label>
                        <input type="password" id="signupPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" id="signupBtn">Create Account</button>
                    <div class="auth-footer">
                        Already have an account? <button type="button" class="auth-link" onclick="switchAuthTab('login')">Log in</button>
                    </div>
                </form>
                
                <!-- Forgot Password Form -->
                <form class="auth-form" id="forgotForm" onsubmit="handleForgotPassword(event)">
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
                        Enter your email and we'll send you a link to reset your password.
                    </p>
                    <div class="form-group">
                        <label for="forgotEmail">Email</label>
                        <input type="email" id="forgotEmail" placeholder="you@example.com" required>
                    </div>
                    <button type="submit" id="forgotBtn">Send Reset Link</button>
                    <div class="auth-footer">
                        <button type="button" class="auth-link" onclick="switchAuthTab('login')">‚Üê Back to login</button>
                    </div>
                </form>
                
                <!-- Reset Password Form -->
                <form class="auth-form" id="resetForm" onsubmit="handleResetPassword(event)">
                    <div class="form-group">
                        <label for="resetPassword">New Password</label>
                        <input type="password" id="resetPassword" placeholder="At least 8 characters" minlength="8" required>
                    </div>
                    <div class="form-group">
                        <label for="resetPasswordConfirm">Confirm New Password</label>
                        <input type="password" id="resetPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" id="resetBtn">Reset Password</button>
                </form>
                
                <!-- Verification Needed -->
                <div class="auth-form" id="verificationNeeded">
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìß</div>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Please verify your email to continue. Check your inbox for a verification link.
                        </p>
                        <button type="button" class="btn-secondary" onclick="resendVerification()">Resend Verification Email</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- eBay Listing Preview Modal -->
    <div class="listing-modal-overlay" id="listingModal">
        <div class="listing-modal">
            <div class="listing-modal-header">
                <h3>üì¶ Preview eBay Listing</h3>
                <button class="listing-modal-close" onclick="closeListingModal()">&times;</button>
            </div>
            <div class="listing-modal-body" id="listingModalBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="listing-modal-footer">
                <button class="listing-btn-cancel" onclick="closeListingModal()">Cancel</button>
                <button class="listing-btn-confirm" id="confirmListingBtn" onclick="confirmListing()">
                    Confirm & List on eBay
                        </button>
            </div>
        </div>
    </div>
    
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="js/grading.js"></script>
    
    <!-- Auto-select tab from URL hash, default to grading -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const hash = window.location.hash.replace('#', '');
            if (hash === 'manual') {
                setMode('manual');
            } else {
                // Default to grading mode
                setMode('grading');
            }
        });
    </script>
    
    <!-- Footer -->
    <footer style="text-align: center; padding: 20px 0; margin-top: 40px; color: var(--text-secondary); font-size: 13px; border-top: 1px solid var(--border-color);">
        <div style="margin-bottom: 8px;">
            <a href="/cdn-cgi/l/email-protection#592a2c2929362b2d192a35383b2e362b2d3120773a3634" style="color: var(--text-secondary); text-decoration: none; margin: 0 12px;">Contact</a>
            <a href="/privacy.html" style="color: var(--text-secondary); text-decoration: none; margin: 0 12px;">Privacy</a>
            <a href="/terms.html" style="color: var(--text-secondary); text-decoration: none; margin: 0 12px;">Terms</a>
        </div>
        <div>Powered by <a href="https://collectioncalc.com" style="color: var(--primary); text-decoration: none;">CollectionCalc</a>‚Ñ¢