<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slab Worthy&trade; - AI Comic Grading</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script>
        // Auth gate ‚Äî redirect to login if not authenticated
        (function() {
            const token = localStorage.getItem('cc_token');
            if (!token) {
                window.location.replace('/login.html');
            }
        })();
    </script>
    <style>
        /* Gold Bangers logo for app header */
        .header-brand h1 {
            font-family: 'Bangers', cursive !important;
            font-size: clamp(1.8rem, 5vw, 2.5rem) !important;
            letter-spacing: 2px !important;
            color: #facc15 !important;
            -webkit-text-fill-color: #facc15 !important;
            background: none !important;
            -webkit-background-clip: unset !important;
            background-clip: unset !important;
            text-shadow: 1px 1px 0 #7c3aed, 2px 2px 0 #1e1b4b !important;
            margin: 0;
            line-height: 1.1;
        }
        .header-brand .subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 0.75rem;
            margin-top: 2px;
        }

        /* Hide Take Photo button on desktop - only show on mobile */
        @media (min-width: 768px) {
            .photo-option-btn.camera {
                display: none !important;
            }
            .mobile-only {
                display: none !important;
            }
        }
        @media (max-width: 767px) {
            .desktop-only {
                display: none !important;
            }
        }
        
        /* Comic-shaped upload boxes */
        #gradingUpload1, #gradingUpload3 {
            /* Front & Back Cover - 7:10 comic ratio */
            aspect-ratio: 7 / 10;
            max-width: 280px;
            margin: 0 auto;
        }
        #gradingUpload2 {
            /* Spine - narrow and tall */
            aspect-ratio: 1 / 6;
            max-width: 80px;
            margin: 0 auto;
        }
        #gradingUpload4 {
            /* Centerfold - open book landscape */
            aspect-ratio: 14 / 10;
            max-width: 450px;
            margin: 0 auto;
            position: relative;
        }
        #gradingUpload4::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 10%;
            height: 80%;
            border-left: 2px dashed rgba(99, 102, 241, 0.4);
            pointer-events: none;
            z-index: 1;
        }
        
        /* Adjust button layout for narrow spine */
        #gradingUpload2 .photo-option-btn {
            padding: 8px 4px;
            font-size: 12px;
        }
        #gradingUpload2 .photo-option-icon {
            font-size: 1.2rem;
        }
        #gradingUpload2 .photo-option-text {
            display: none;
        }
        
        /* Photo diagram container */
        .photo-diagram-container {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        /* Photo diagram grid */
        .photo-diagram {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        /* Top row: Front, Spine, Back */
        .photo-diagram-row-top {
            display: flex;
            gap: 4px;
            align-items: flex-end;
        }

        /* Bottom row: Centerfold (centered) */
        .photo-diagram-row-bottom {
            display: flex;
            justify-content: center;
        }

        /* Individual photo boxes */
        .photo-box {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(168, 85, 247, 0.4);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
            font-size: 8px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        /* Front and Back - tall rectangles (7:10 ratio) */
        .photo-front,
        .photo-back {
            width: 38px;
            height: 54px;
        }

        /* Spine - narrow strip */
        .photo-spine {
            width: 12px;
            height: 54px;
            font-size: 6px;
            line-height: 1;
            padding: 2px 0;
            letter-spacing: 0;
            word-break: break-all;
        }

        /* Centerfold - wider horizontal */
        .photo-centerfold {
            width: 76px;
            height: 54px;
        }

        /* Active state - highlighted box */
        .photo-box.active {
            border-color: rgb(168, 85, 247);
            background: rgba(168, 85, 247, 0.2);
            color: rgb(168, 85, 247);
            box-shadow: 0 0 12px rgba(168, 85, 247, 0.4);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Pulse animation for active box */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 12px rgba(168, 85, 247, 0.4);
            }
            50% {
                box-shadow: 0 0 20px rgba(168, 85, 247, 0.6);
            }
        }

        /* Diagram label */
        .photo-diagram-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        /* Mobile adjustments for photo diagram */
        @media (max-width: 767px) {
            .photo-diagram {
                padding: 0.75rem;
            }
            
            .photo-front,
            .photo-back {
                width: 32px;
                height: 46px;
            }
            
            .photo-spine {
                width: 10px;
                height: 46px;
                font-size: 5px;
            }
            
            .photo-centerfold {
                width: 64px;
                height: 46px;
            }
            
            .photo-box {
                font-size: 7px;
            }
            
            .photo-diagram-label {
                font-size: 10px;
            }
        }

        /* ========================================== 
           INTERACTIVE UPLOAD DIAGRAM 
           ========================================== */
        .photo-upload-diagram {
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            margin: 2rem 0;
        }

        .photo-upload-row-top {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .photo-upload-row-bottom {
            display: flex;
            justify-content: center;
        }

        /* Upload boxes - interactive */
        .photo-upload-box {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid rgba(168, 85, 247, 0.4);
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .photo-upload-box:hover {
            transform: scale(1.05);
            border-color: rgb(168, 85, 247);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }

        /* Sizing */
        .photo-upload-box {
            width: 120px;
            height: 170px;
        }

        .photo-spine-upload {
            width: 40px;
            height: 170px;
        }

        .photo-centerfold-upload {
            width: 296px;
            height: 170px;
        }

        /* Upload box content (before upload) */
        .upload-box-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 1rem;
            text-align: center;
        }

        .upload-box-label {
            font-size: 14px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .upload-box-label-vertical {
            font-size: 12px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 2px;
            line-height: 1.4;
        }

        .upload-box-icon {
            font-size: 32px;
            opacity: 0.6;
        }

        .upload-box-hint {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }

        /* Required indicator for front */
        .photo-upload-box[data-required="true"] {
            border-color: rgba(245, 158, 11, 0.6);
        }

        .photo-upload-box[data-required="true"]:hover {
            border-color: rgb(245, 158, 11);
        }

        /* Highlight state - suggests next upload */
        .photo-upload-box.highlight {
            border-color: rgb(168, 85, 247);
            background: rgba(168, 85, 247, 0.15);
            animation: pulse-upload 2s ease-in-out infinite;
        }

        @keyframes pulse-upload {
            0%, 100% {
                box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
            }
            50% {
                box-shadow: 0 0 30px rgba(168, 85, 247, 0.7);
            }
        }

        /* Uploaded state */
        .photo-upload-box.uploaded .upload-box-content {
            display: none;
        }

        .upload-box-thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        .photo-upload-box.uploaded .upload-box-thumbnail {
            display: block;
        }

        .upload-box-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-checkmark {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgb(16, 185, 129);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Hidden file inputs */
        .upload-input-hidden {
            display: none;
        }

        /* Upload progress indicator */
        .upload-progress-indicator {
            margin: 1.5rem 0;
            text-align: center;
        }

        .progress-text {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .progress-bar-container {
            width: 100%;
            max-width: 400px;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 auto;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, rgb(168, 85, 247), rgb(99, 102, 241));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Warning banner */
        .upload-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .warning-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .warning-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        /* Mobile responsive */
        @media (max-width: 767px) {
            .photo-upload-diagram {
                padding: 1rem;
            }

            .photo-upload-box {
                width: 90px;
                height: 130px;
            }

            .photo-spine-upload {
                width: 30px;
                height: 130px;
            }

            .photo-centerfold-upload {
                width: 226px;
                height: 130px;
            }

            .upload-box-label {
                font-size: 11px;
            }

            .upload-box-icon {
                font-size: 24px;
            }

            .upload-box-hint {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-brand">
                <h1>SLAB WORTHY<span style="font-size: 0.6em; vertical-align: super;">‚Ñ¢</span></h1>
                <p class="subtitle">AI for Comic Collectors</p>
            </div>
            <div class="header-auth" id="headerAuth">
                <!-- Logged out state -->
                <div id="authLoggedOut">
                    <button class="auth-btn auth-btn-login" onclick="openAuthModal('login')">Log In</button>
                    <button class="auth-btn auth-btn-signup" onclick="openAuthModal('signup')">Sign Up</button>
                </div>
                <!-- Logged in state -->
                <div id="authLoggedIn" style="display: none;">
                    <button class="save-collection-btn" onclick="showCollection()" title="My Collection">
                        üìö My Collection
                    </button>
                    <div class="user-menu">
                        <button class="user-menu-btn" onclick="toggleUserMenu()">
                            <div class="user-avatar" id="userAvatar">?</div>
                            <span id="userEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2f5a5c4a5d6f4a574e425f434a014c4042">[email&#160;protected]</a></span>
                            <span>‚ñæ</span>
                        </button>
                        <div class="user-menu-dropdown" id="userMenuDropdown">
                            <button class="user-menu-item" onclick="showCollection()">üìö My Collection</button>
                            <button class="user-menu-item admin-only" id="adminMenuItem" onclick="window.location.href='/admin.html'" style="display:none;">üîß Admin</button>
                            <div class="user-menu-divider"></div>
                            <button class="user-menu-item danger" onclick="logout()">Log Out</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div id="mainApp">
            <div class="mode-toggle" style="display: none;">
                <button class="mode-btn active" id="modeGrading" onclick="setMode('grading')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-right: 4px;"><rect x="3" y="1" width="18" height="22" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><rect x="6" y="4" width="12" height="13" rx="1" fill="rgba(99, 102, 241, 0.15)" stroke="currentColor" stroke-width="1"/><text x="12" y="14" text-anchor="middle" fill="currentColor" font-size="10" font-weight="bold" font-family="Arial">?</text><rect x="6" y="18" width="12" height="3" rx="0.5" fill="currentColor"/></svg> Slab Worthy&trade;?</button>
                <button class="mode-btn" id="modeManual" onclick="setMode('manual')">‚úèÔ∏è Manual Entry</button>
            </div>
            
            <div class="card">
                <!-- Manual Entry Mode -->
                <div id="manualMode" style="display: none;">
                    <form id="valuationForm">
                        <div class="form-group">
                            <label for="title">Comic Title</label>
                            <input type="text" id="title" placeholder="e.g. Amazing Spider-Man (or ASM)" required>
                        </div>
                        <div class="row">
                            <div class="form-group">
                                <label for="issue">Issue #</label>
                                <input type="text" id="issue" placeholder="e.g. 300" required>
                            </div>
                            <div class="form-group">
                                <label for="grade">Grade</label>
                                <select id="grade">
                                    <option value="NM">Near Mint (NM)</option>
                                    <option value="VF" selected>Very Fine (VF)</option>
                                    <option value="FN">Fine (FN)</option>
                                    <option value="VG">Very Good (VG)</option>
                                    <option value="G">Good (G)</option>
                                    <option value="FR">Fair (FR)</option>
                                    <option value="PR">Poor (PR)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" id="submitBtn">Get Valuation</button>
                    </form>
                </div>
                
                <!-- Photo Upload Mode -->
                <div id="photoMode" style="display: none;">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('photoInput').click();">
                        <input type="file" id="photoInput" class="upload-input" accept=".jpg,.jpeg,.png,.webp,.heic" multiple onchange="handlePhotoUpload(this.files)">
                        <div class="upload-icon">üì∏</div>
                        <div class="upload-title">Click to upload or drag & drop</div>
                        <div class="upload-subtitle">Select one or multiple comic photos</div>
                    </div>
                </div>
                
                <!-- ========================================== -->
                <!-- GRADE MY COMIC MODE - DEFAULT -->
                <!-- ========================================== -->
                <div id="gradingMode">
                    
                    <!-- Progress Steps Indicator -->
                    <div class="grading-progress">
                        <div class="grading-step active" id="gradingStep1">
                            <div class="step-number">1</div>
                            <div class="step-label">Upload Photos</div>
                        </div>
                        <div class="grading-step-line"></div>
                        <div class="grading-step" id="gradingStep2">
                            <div class="step-number">2</div>
                            <div class="step-label">Slab Report</div>
                        </div>
                    </div>
                    
                    <!-- Single Page Upload Interface -->
                    <div class="grading-step-content active" id="gradingContent1">
                        <div class="grading-header">
                            <h3>üì∑ Upload Your Comic Photos</h3>
                            <p class="grading-subtitle">Click each section to upload. Front cover is required.</p>
                        </div>
                        
                        <!-- Interactive Photo Diagram -->
                        <div class="photo-upload-diagram">
                            <!-- Top Row: Front, Spine, Back -->
                            <div class="photo-upload-row-top">
                                <div class="photo-upload-box" id="uploadBoxFront" data-photo-type="front" data-required="true" onclick="triggerPhotoUpload('front')">
                                    <input type="file" id="uploadInputFront" class="upload-input-hidden" accept="image/*" capture="environment" onchange="handlePhotoUpload('front', this.files)">
                                    <div class="upload-box-content">
                                        <div class="upload-box-label">FRONT*</div>
                                        <div class="upload-box-icon">üì∑</div>
                                        <div class="upload-box-hint">Click to upload</div>
                                    </div>
                                    <div class="upload-box-thumbnail" id="thumbnailFront" style="display: none;">
                                        <img id="imgFront" src="" alt="Front cover">
                                        <div class="thumbnail-checkmark">‚úì</div>
                                    </div>
                                </div>
                                
                                <div class="photo-upload-box photo-spine-upload" id="uploadBoxSpine" data-photo-type="spine" onclick="triggerPhotoUpload('spine')">
                                    <input type="file" id="uploadInputSpine" class="upload-input-hidden" accept="image/*" capture="environment" onchange="handlePhotoUpload('spine', this.files)">
                                    <div class="upload-box-content">
                                        <div class="upload-box-label-vertical">S<br>P<br>I<br>N<br>E</div>
                                        <div class="upload-box-icon">üì∑</div>
                                    </div>
                                    <div class="upload-box-thumbnail" id="thumbnailSpine" style="display: none;">
                                        <img id="imgSpine" src="" alt="Spine">
                                        <div class="thumbnail-checkmark">‚úì</div>
                                    </div>
                                </div>
                                
                                <div class="photo-upload-box" id="uploadBoxBack" data-photo-type="back" onclick="triggerPhotoUpload('back')">
                                    <input type="file" id="uploadInputBack" class="upload-input-hidden" accept="image/*" capture="environment" onchange="handlePhotoUpload('back', this.files)">
                                    <div class="upload-box-content">
                                        <div class="upload-box-label">BACK</div>
                                        <div class="upload-box-icon">üì∑</div>
                                        <div class="upload-box-hint">Click to upload</div>
                                    </div>
                                    <div class="upload-box-thumbnail" id="thumbnailBack" style="display: none;">
                                        <img id="imgBack" src="" alt="Back cover">
                                        <div class="thumbnail-checkmark">‚úì</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bottom Row: Centerfold -->
                            <div class="photo-upload-row-bottom">
                                <div class="photo-upload-box photo-centerfold-upload" id="uploadBoxCenterfold" data-photo-type="centerfold" onclick="triggerPhotoUpload('centerfold')">
                                    <input type="file" id="uploadInputCenterfold" class="upload-input-hidden" accept="image/*" capture="environment" onchange="handlePhotoUpload('centerfold', this.files)">
                                    <div class="upload-box-content">
                                        <div class="upload-box-label">CENTERFOLD</div>
                                        <div class="upload-box-icon">üì∑</div>
                                        <div class="upload-box-hint">Click to upload</div>
                                    </div>
                                    <div class="upload-box-thumbnail" id="thumbnailCenterfold" style="display: none;">
                                        <img id="imgCenterfold" src="" alt="Centerfold">
                                        <div class="thumbnail-checkmark">‚úì</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload Progress -->
                        <div class="upload-progress-indicator">
                            <div class="progress-text" id="uploadProgressText">0 of 4 photos uploaded</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="uploadProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Warning Banner -->
                        <div class="upload-warning" id="uploadWarning" style="display: none;">
                            <span class="warning-icon">‚ö†Ô∏è</span>
                            <span class="warning-text">Upload all 4 photos for the most accurate assessment. Analysis with fewer photos will have limited accuracy.</span>
                        </div>
                        
                        <!-- Photo Tips -->
                        <div class="grading-tips">
                            <button type="button" class="tips-toggle" onclick="togglePhotoTips()">üí° Photo tips</button>
                            <div class="tips-content" id="photoTips" style="display: none;">
                                <ul>
                                    <li><strong>Lighting:</strong> Natural, indirect light works best. Avoid glare and shadows.</li>
                                    <li><strong>Angle:</strong> Hold camera parallel to comic. Keep it level and centered.</li>
                                    <li><strong>Distance:</strong> Fill most of frame with comic, leaving small border.</li>
                                    <li><strong>Focus:</strong> Tap to focus. Make sure text is sharp and readable.</li>
                                    <li><strong>Background:</strong> Plain, neutral background (white/black preferred).</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Generate Button -->
                        <div class="grading-actions">
                            <button type="button" class="btn-primary btn-large" id="generateReportBtn" onclick="generateGradeReport()" disabled>
                                Generate Slab Report ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Grade Report -->
                    <div class="grading-step-content" id="gradingContent5">
                        <div class="grading-header">
                            <h3>üìã Slab Report</h3>
                            <span class="grading-patent">Patent Pending</span>
                        </div>
                        
                        <!-- Comic Identification -->
                        <div class="grade-report-comic" id="gradeReportComic">
                            <!-- Title, issue, publisher, year -->
                        </div>
                        
                        <!-- Grade Result -->
                        <div class="grade-report-result" id="gradeReportResult">
                            <div class="grade-big" id="gradeResultBig">--</div>
                            <div class="grade-label" id="gradeResultLabel">Analyzing...</div>
                            <div class="grade-quality-warning" id="gradeQualityWarning" style="display: none;">
                                <span class="warning-icon">‚ö†Ô∏è</span>
                                <span class="warning-text">Grade based on limited photos. Add spine, back, and centerfold for higher confidence.</span>
                            </div>
                            <div class="grade-photos-used" id="gradePhotosUsed">
                                <!-- Shows which photos were analyzed -->
                            </div>
                        </div>
                        
                        <!-- Defects Found -->
                        <div class="grade-report-defects" id="gradeReportDefects">
                            <h4>Defects Found</h4>
                            <div class="defects-list" id="defectsList">
                                <!-- Defects by area -->
                            </div>
                        </div>
                        
                        <!-- Should You Grade? -->
                        <div class="grade-report-recommendation" id="gradeReportRecommendation">
                            <h4><svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-right: 4px;"><rect x="3" y="1" width="18" height="22" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><rect x="6" y="4" width="12" height="13" rx="1" fill="rgba(99, 102, 241, 0.15)" stroke="currentColor" stroke-width="1"/><text x="12" y="14" text-anchor="middle" fill="currentColor" font-size="10" font-weight="bold" font-family="Arial">?</text><rect x="6" y="18" width="12" height="3" rx="0.5" fill="currentColor"/></svg> Should You Slab It?</h4>
                            <div class="recommendation-values" id="recommendationValues">
                                <!-- Market values and calculation -->
                            </div>
                            <div class="recommendation-verdict" id="recommendationVerdict">
                                <!-- SUBMIT / KEEP RAW recommendation -->
                            </div>
                        </div>
                        
                        <!-- Signature Detection (if found) -->
                        <div class="grade-report-signature" id="gradeReportSignature" style="display: none;">
                            <h4>‚úçÔ∏è Signature Detected</h4>
                            <div id="signatureInfo">
                                <!-- Signature analysis -->
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="grading-actions">
                            <button type="button" class="btn-secondary" onclick="resetGrading()">‚Üê Grade Another</button>
                            <button type="button" class="btn-primary" onclick="saveGradeToCollection()">üíæ Save to Collection</button>
                        </div>
                    </div>
                    
                </div>
                <!-- END GRADE MY COMIC MODE -->
                
                <!-- Bulk Extracted Items -->
                <div id="bulkMode" style="display: none;">
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progressText">Calculating...</div>
                    </div>
                    
                    <div id="itemsList"></div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn-secondary" onclick="resetToPhoto()">‚Üê Add More Photos</button>
                        <button type="button" id="valuateAllBtn" onclick="valuateAll()">Get All Valuations</button>
                    </div>
                </div>
                
                <!-- Results Summary (for bulk) -->
                <div id="resultsMode" style="display: none;">
                    <div class="summary-card">
                        <div class="result-label">Total Collection Value</div>
                        <div class="summary-total" id="totalValue">$0.00</div>
                        <div class="summary-count" id="itemCount">0 items valued</div>
                    </div>
                    
                    <div class="sort-controls">
                        <label for="sortSelect">Sort by:</label>
                        <select id="sortSelect" onchange="sortResults(this.value)">
                            <option value="default">Order Added</option>
                            <option value="value-high">Value (High to Low)</option>
                            <option value="value-low">Value (Low to High)</option>
                            <option value="title">Title (A-Z)</option>
                        </select>
                    </div>
                    
                    <div id="resultsList"></div>
                    
                    <div class="action-buttons">
                        <button type="button" class="btn-secondary" onclick="resetApp()">‚Üê Start Over</button>
                        <button type="button" onclick="downloadExcel()">üì• Download Excel</button>
                        <button type="button" class="save-collection-btn" onclick="saveAllToCollection()" id="saveCollectionBtn">
                            üíæ Save to Collection
                        </button>
                    </div>
                </div>
                
                <!-- Single Result (for manual entry) -->
                <div class="result" id="result">
                    <div class="result-card" id="resultCard">
                        <div id="resultContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- Thinking Indicator -->
            <div class="thinking-indicator" id="thinkingIndicator" style="display: none;">
                <div class="thinking-header">
                    <div class="thinking-calc">
                        <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Calculator body -->
                            <rect x="4" y="2" width="24" height="28" rx="3" stroke="url(#calcGrad)" stroke-width="2.5" fill="var(--bg-card)"/>
                            <!-- Display -->
                            <rect x="7" y="5" width="18" height="7" rx="1" fill="var(--bg-primary)" stroke="var(--brand-indigo)" stroke-width="1"/>
                            <text x="9" y="10.5" class="calc-display">$---</text>
                            <!-- Buttons row 1 -->
                            <rect class="calc-btn1" x="7" y="15" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect class="calc-btn2" x="14" y="15" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect class="calc-btn3" x="21" y="15" width="4" height="3" rx="0.5" fill="var(--brand-purple)"/>
                            <!-- Buttons row 2 -->
                            <rect class="calc-btn4" x="7" y="20" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect class="calc-btn5" x="14" y="20" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect class="calc-btn6" x="21" y="20" width="4" height="3" rx="0.5" fill="var(--brand-cyan)"/>
                            <!-- Buttons row 3 -->
                            <rect x="7" y="25" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect x="14" y="25" width="4" height="3" rx="0.5" fill="var(--brand-indigo)"/>
                            <rect x="21" y="25" width="4" height="3" rx="0.5" fill="var(--status-success)"/>
                            <defs>
                                <linearGradient id="calcGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="var(--brand-indigo)"/>
                                    <stop offset="100%" stop-color="var(--brand-purple)"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <span class="thinking-title" id="thinkingTitle">Calculating...</span>
                </div>
                <div class="thinking-steps">
                    <div class="thinking-step pending" id="step1"><span class="icon"></span><span id="step1Text">Checking database for matches</span></div>
                    <div class="thinking-step pending" id="step2"><span class="icon"></span><span id="step2Text">Searching market data</span></div>
                    <div class="thinking-step pending" id="step3"><span class="icon"></span><span id="step3Text">Crunching the numbers</span></div>
                    <div class="thinking-step pending" id="step4"><span class="icon"></span><span id="step4Text">Calculating confidence score</span></div>
                    <div class="thinking-step pending" id="step5"><span class="icon"></span><span id="step5Text">Generating valuation</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Photo Tips Modal -->
    <div class="tips-modal-overlay" id="photoTipsModal">
        <div class="tips-modal">
            <div class="tips-modal-header">
                <h3>üì∏ How to Take Great Comic Photos</h3>
                <button class="tips-modal-close" onclick="closePhotoTips()">&times;</button>
            </div>
            <div class="tips-modal-body">
                <div class="tips-section">
                    <h4>üîÜ Lighting</h4>
                    <ul>
                        <li><strong>Do:</strong> Use natural light or bright, even lighting</li>
                        <li><strong>Don't:</strong> Use flash (causes glare) or dim lighting</li>
                    </ul>
                </div>
                <div class="tips-section">
                    <h4>üìê Angle</h4>
                    <ul>
                        <li><strong>Do:</strong> Shoot straight on, perpendicular to the comic</li>
                        <li><strong>Don't:</strong> Shoot at an angle (distorts proportions)</li>
                    </ul>
                </div>
                <div class="tips-section">
                    <h4>üîç Focus</h4>
                    <ul>
                        <li><strong>Do:</strong> Tap to focus, hold steady, ensure sharp image</li>
                        <li><strong>Don't:</strong> Move while shooting (causes blur)</li>
                    </ul>
                </div>
                <div class="tips-section">
                    <h4>üìè Framing</h4>
                    <ul>
                        <li><strong>Do:</strong> Include entire cover/spine with small margin</li>
                        <li><strong>Don't:</strong> Cut off edges or get too close</li>
                    </ul>
                </div>
                <div class="tips-section">
                    <h4>üéØ By Photo Type</h4>
                    <ul>
                        <li><strong>Front Cover:</strong> Full cover, all corners visible</li>
                        <li><strong>Spine:</strong> Turn comic sideways, spine fills frame vertically</li>
                        <li><strong>Back Cover:</strong> Same as front, full cover visible</li>
                        <li><strong>Centerfold:</strong> Open flat, show both staples clearly</li>
                    </ul>
                </div>
            </div>
            <div class="tips-modal-footer">
                <button class="btn-primary" onclick="closePhotoTips()">Got it!</button>
            </div>
        </div>
    </div>
    
    <!-- Auth Modal -->
    <div class="auth-modal-overlay" id="authModal">
        <div class="auth-modal">
            <button class="auth-modal-close" onclick="closeAuthModal()">&times;</button>
            <div class="auth-modal-header">
                <h2 id="authModalTitle">Welcome Back</h2>
                <p id="authModalSubtitle">Log in to save your collection</p>
            </div>
            <div class="auth-modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">Log In</button>
                    <button class="auth-tab" id="tabSignup" onclick="switchAuthTab('signup')">Sign Up</button>
                </div>
                
                <div class="auth-error" id="authError"></div>
                <div class="auth-success" id="authSuccess"></div>
                
                <!-- Login Form -->
                <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" id="loginBtn">Log In</button>
                    <div class="auth-footer">
                        <button type="button" class="auth-link" onclick="showForgotPassword()">Forgot password?</button>
                    </div>
                </form>
                
                <!-- Signup Form -->
                <form class="auth-form" id="signupForm" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="At least 8 characters" minlength="8" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPasswordConfirm">Confirm Password</label>
                        <input type="password" id="signupPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" id="signupBtn">Create Account</button>
                    <div class="auth-footer">
                        Already have an account? <button type="button" class="auth-link" onclick="switchAuthTab('login')">Log in</button>
                    </div>
                </form>
                
                <!-- Forgot Password Form -->
                <form class="auth-form" id="forgotForm" onsubmit="handleForgotPassword(event)">
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
                        Enter your email and we'll send you a link to reset your password.
                    </p>
                    <div class="form-group">
                        <label for="forgotEmail">Email</label>
                        <input type="email" id="forgotEmail" placeholder="you@example.com" required>
                    </div>
                    <button type="submit" id="forgotBtn">Send Reset Link</button>
                    <div class="auth-footer">
                        <button type="button" class="auth-link" onclick="switchAuthTab('login')">‚Üê Back to login</button>
                    </div>
                </form>
                
                <!-- Reset Password Form -->
                <form class="auth-form" id="resetForm" onsubmit="handleResetPassword(event)">
                    <div class="form-group">
                        <label for="resetPassword">New Password</label>
                        <input type="password" id="resetPassword" placeholder="At least 8 characters" minlength="8" required>
                    </div>
                    <div class="form-group">
                        <label for="resetPasswordConfirm">Confirm New Password</label>
                        <input type="password" id="resetPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" id="resetBtn">Reset Password</button>
                </form>
                
                <!-- Verification Needed -->
                <div class="auth-form" id="verificationNeeded">
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìß</div>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Please verify your email to continue. Check your inbox for a verification link.
                        </p>
                        <button type="button" class="btn-secondary" onclick="resendVerification()">Resend Verification Email</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- eBay Listing Preview Modal -->
    <div class="listing-modal-overlay" id="listingModal">
        <div class="listing-modal">
            <div class="listing-modal-header">
                <h3>üì¶ Preview eBay Listing</h3>
                <button class="listing-modal-close" onclick="closeListingModal()">&times;</button>
            </div>
            <div class="listing-modal-body" id="listingModalBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="listing-modal-footer">
                <button class="listing-btn-cancel" onclick="closeListingModal()">Cancel</button>
                <button class="listing-btn-confirm" id="confirmListingBtn" onclick="confirmListing()">
                    Confirm & List on eBay
                        </button>
            </div>
        </div>
    </div>
    
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script src="js/grading.js"></script>
    
    <!-- Single Page Upload JavaScript -->
    <script>
        // Trigger file input when box is clicked
        function triggerPhotoUpload(photoType) {
            document.getElementById(`uploadInput${capitalize(photoType)}`).click();
        }
        
        // Handle photo upload
        async function handlePhotoUpload(photoType, files) {
            if (!files || files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                // Get photo type number (front=1, spine=2, back=3, centerfold=4)
                const photoMap = { 'front': 1, 'spine': 2, 'back': 3, 'centerfold': 4 };
                const photoNum = photoMap[photoType];
                
                // Store in gradingState.photos with base64 (without data:image prefix)
                const base64Data = e.target.result.split(',')[1];
                const mediaType = e.target.result.split(';')[0].split(':')[1];
                
                window.gradingState.photos[photoNum] = {
                    base64: base64Data,
                    mediaType: mediaType,
                    file: file
                };
                
                // Update UI
                const box = document.getElementById(`uploadBox${capitalize(photoType)}`);
                const thumbnail = document.getElementById(`thumbnail${capitalize(photoType)}`);
                const img = document.getElementById(`img${capitalize(photoType)}`);
                
                // Show thumbnail
                img.src = e.target.result;
                thumbnail.style.display = 'block';
                box.classList.add('uploaded');
                box.classList.remove('highlight');
                
                // Update progress
                updateUploadProgress();
                
                // Highlight next box
                highlightNextBox(photoType);
                
                // Special handling for FRONT photo - extract comic data
                if (photoType === 'front') {
                    await extractComicData(e.target.result);
                }
                
                // Enable generate button if front is uploaded AND extracted
                if (window.gradingState.photos[1] && window.gradingState.extractedData) {
                    document.getElementById('generateReportBtn').disabled = false;
                }
            };
            
            reader.readAsDataURL(file);
        }
        
        // Extract comic data from front cover
        async function extractComicData(dataUrl) {
            const progressText = document.getElementById('uploadProgressText');
            const generateBtn = document.getElementById('generateReportBtn');
            
            try {
                // Show extracting state
                progressText.textContent = 'üîç Identifying comic...';
                generateBtn.disabled = true;
                
                // Get auth token
                const authToken = localStorage.getItem('cc_token');
                if (!authToken) {
                    throw new Error('Not authenticated');
                }
                
                // Extract base64 data (remove data:image/...;base64, prefix)
                const base64Data = dataUrl.split(',')[1];
                const mediaType = dataUrl.split(';')[0].split(':')[1];
                
                // Call extraction API (using API_URL from utils.js)
                const response = await fetch(`${API_URL}/api/extract`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        image: base64Data,
                        media_type: mediaType
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Extraction failed');
                }
                
                // Store extracted data in gradingState
                window.gradingState.extractedData = data.extracted;
                
                // Update progress text with comic info
                const title = data.extracted.title || 'Unknown';
                const issue = data.extracted.issue || '?';
                progressText.textContent = `‚úì Identified: ${title} #${issue}`;
                
                // Enable button now that extraction is complete
                generateBtn.disabled = false;
                
            } catch (error) {
                console.error('Extraction error:', error);
                // Still allow grading even if extraction fails
                progressText.textContent = '‚ö†Ô∏è Could not identify comic - you can still grade';
                generateBtn.disabled = false;
            }
        }
        
        // Update upload progress indicator
        function updateUploadProgress() {
            const uploadCount = Object.values(gradingState.photos).filter(p => p !== null).length;
            const progressText = document.getElementById('uploadProgressText');
            const progressBar = document.getElementById('uploadProgressBar');
            const warning = document.getElementById('uploadWarning');
            
            // Don't overwrite extraction message (if it contains "Identifying" or "Identified")
            if (!progressText.textContent.includes('Identifying') && 
                !progressText.textContent.includes('Identified') && 
                !progressText.textContent.includes('Could not identify')) {
                progressText.textContent = `${uploadCount} of 4 photos uploaded`;
            }
            
            progressBar.style.width = `${(uploadCount / 4) * 100}%`;
            
            // Show warning if less than 4 photos and at least 1 uploaded
            if (uploadCount > 0 && uploadCount < 4) {
                warning.style.display = 'flex';
            } else {
                warning.style.display = 'none';
            }
        }
        
        // Highlight next box in sequence
        function highlightNextBox(currentType) {
            // Remove all highlights
            document.querySelectorAll('.photo-upload-box').forEach(box => {
                box.classList.remove('highlight');
            });
            
            // Sequence: front -> spine -> back -> centerfold
            const sequence = ['front', 'spine', 'back', 'centerfold'];
            const photoMap = { 'front': 1, 'spine': 2, 'back': 3, 'centerfold': 4 };
            const currentIndex = sequence.indexOf(currentType);
            
            // Find next unuploaded box
            for (let i = currentIndex + 1; i < sequence.length; i++) {
                const nextType = sequence[i];
                const nextNum = photoMap[nextType];
                if (!gradingState.photos[nextNum]) {
                    document.getElementById(`uploadBox${capitalize(nextType)}`).classList.add('highlight');
                    break;
                }
            }
        }
        
        // Capitalize first letter
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // Initialize - highlight front box
        document.addEventListener('DOMContentLoaded', function() {
            const frontBox = document.getElementById('uploadBoxFront');
            if (frontBox) {
                frontBox.classList.add('highlight');
            }
        });
        
        // Initialize gradingState if it doesn't exist
        if (typeof window.gradingState === 'undefined') {
            window.gradingState = {
                photos: {},
                additionalPhotos: [],
                extractedData: null,
                currentStep: 1
            };
        }
        
        // Store original generateGradeReport from grading.js (we won't use it)
        const originalGenerateGradeReport = window.generateGradeReport;
        
        // Complete standalone grading function
        window.generateGradeReport = async function() {
            // Check if at least front is uploaded
            if (!gradingState.photos[1]) {
                alert('Please upload at least the front cover photo.');
                return;
            }
            
            // Update UI: Switch from upload to report
            const step1 = document.getElementById('gradingStep1');
            const step2 = document.getElementById('gradingStep2');
            const content1 = document.getElementById('gradingContent1');
            const content5 = document.getElementById('gradingContent5');
            
            if (step1) {
                step1.classList.remove('active');
                step1.classList.add('completed');
            }
            if (step2) step2.classList.add('active');
            if (content1) content1.classList.remove('active');
            if (content5) content5.classList.add('active');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Show loading state
            const gradeResultBig = document.getElementById('gradeResultBig');
            const gradeResultLabel = document.getElementById('gradeResultLabel');
            const gradePhotosUsed = document.getElementById('gradePhotosUsed');
            const defectsList = document.getElementById('defectsList');
            
            if (gradeResultBig) gradeResultBig.textContent = '...';
            if (gradeResultLabel) gradeResultLabel.textContent = 'Analyzing photos...';
            if (gradePhotosUsed) gradePhotosUsed.innerHTML = '<span style="color: var(--text-muted);">Processing images...</span>';
            if (defectsList) defectsList.innerHTML = '<span style="color: var(--text-muted);">Finding defects...</span>';
            
            try {
                // Build image array from gradingState.photos
                const imageContent = [];
                const photoLabels = [];
                const labels = { 1: 'Front Cover', 2: 'Spine', 3: 'Back Cover', 4: 'Centerfold' };
                
                Object.entries(gradingState.photos).forEach(([step, photo]) => {
                    if (photo && photo.base64) {
                        imageContent.push({
                            type: 'image',
                            source: {
                                type: 'base64',
                                media_type: photo.mediaType,
                                data: photo.base64
                            }
                        });
                        photoLabels.push(labels[step]);
                    }
                });
                
                // Get comic info from extractedData
                const title = gradingState.extractedData?.title || 'Unknown';
                const issue = gradingState.extractedData?.issue || '?';
                const publisher = gradingState.extractedData?.publisher || 'Unknown';
                
                // Count photos for confidence
                const photosUsed = imageContent.length;
                const baseConfidence = { 1: 65, 2: 78, 3: 88, 4: 94 }[photosUsed] || 65;
                
                // Get auth token
                const authToken = localStorage.getItem('cc_token');
                if (!authToken) {
                    throw new Error('Not authenticated');
                }
                
                // Make grading API call
                const response = await fetch(`${API_URL}/api/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2048,
                        messages: [{
                            role: 'user',
                            content: [
                                ...imageContent,
                                {
                                    type: 'text',
                                    text: `You are grading this comic book using ${photoLabels.length} photos: ${photoLabels.join(', ')}.

The comic has been identified as: ${title} #${issue}
Publisher: ${publisher}

Based on ALL images provided, give a comprehensive grade assessment.

Return a JSON object with these EXACT top-level keys:

{
  "title": "${title}",
  "issue": "${issue}",
  "publisher": "${publisher}",
  "year": "Year if visible",
  "final_grade": 9.4,
  "grade_label": "NM",
  "grade_reasoning": "Detailed explanation",
  "front_defects": ["array", "of", "defects"],
  "spine_defects": ["array", "of", "defects"],
  "back_defects": ["array", "of", "defects"],
  "interior_defects": ["array", "of", "defects"],
  "other_defects": ["array", "of", "defects"],
  "signature_detected": false,
  "signature_info": null
}

Use numeric grades like 9.8, 9.4, 9.0, 8.5, 8.0, 7.5, 7.0, 6.5, 6.0, 5.5, 5.0, 4.5, 4.0, 3.0, 2.0, 1.0.
Grade labels: MT, NM+, NM, NM-, VF+, VF, VF-, FN+, FN, FN-, VG+, VG, VG-, G, FR, PR.

Return ONLY valid JSON, no markdown, no nested objects.`
                                }
                            ]
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'API error');
                }
                
                // Parse response
                let resultText = data.content[0].text;
                resultText = resultText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const result = JSON.parse(resultText);
                
                // Store in gradingState
                gradingState.finalGrade = result;
                gradingState.confidence = baseConfidence;
                
                // Display results
                if (gradeResultBig) gradeResultBig.textContent = result.final_grade || '?';
                if (gradeResultLabel) gradeResultLabel.textContent = result.grade_label || 'Unknown';
                
                // Display photos used
                if (gradePhotosUsed) {
                    gradePhotosUsed.innerHTML = `<strong>${photosUsed} photos analyzed</strong> (${photoLabels.join(', ')}) ‚Ä¢ Confidence: ${baseConfidence}%`;
                }
                
                // Display defects
                if (defectsList) {
                    let defectsHTML = '';
                    
                    if (result.front_defects && result.front_defects.length > 0) {
                        defectsHTML += '<div class="defect-section"><strong>FRONT</strong><ul>';
                        result.front_defects.forEach(d => defectsHTML += `<li>${d}</li>`);
                        defectsHTML += '</ul></div>';
                    }
                    
                    if (result.spine_defects && result.spine_defects.length > 0) {
                        defectsHTML += '<div class="defect-section"><strong>SPINE</strong><ul>';
                        result.spine_defects.forEach(d => defectsHTML += `<li>${d}</li>`);
                        defectsHTML += '</ul></div>';
                    }
                    
                    if (result.back_defects && result.back_defects.length > 0) {
                        defectsHTML += '<div class="defect-section"><strong>BACK</strong><ul>';
                        result.back_defects.forEach(d => defectsHTML += `<li>${d}</li>`);
                        defectsHTML += '</ul></div>';
                    }
                    
                    if (result.interior_defects && result.interior_defects.length > 0) {
                        defectsHTML += '<div class="defect-section"><strong>INTERIOR</strong><ul>';
                        result.interior_defects.forEach(d => defectsHTML += `<li>${d}</li>`);
                        defectsHTML += '</ul></div>';
                    }
                    
                    if (result.other_defects && result.other_defects.length > 0) {
                        defectsHTML += '<div class="defect-section"><strong>OTHER</strong><ul>';
                        result.other_defects.forEach(d => defectsHTML += `<li>${d}</li>`);
                        defectsHTML += '</ul></div>';
                    }
                    
                    if (!defectsHTML) {
                        defectsHTML = '<p style="color: var(--text-muted);">No significant defects detected</p>';
                    }
                    
                    defectsList.innerHTML = defectsHTML;
                }
                
                // Display comic info at top
                const gradeReportComic = document.getElementById('gradeReportComic');
                if (gradeReportComic) {
                    gradeReportComic.innerHTML = `
                        <h2>${result.title || 'Unknown'} #${result.issue || '?'}</h2>
                        <p class="comic-metadata">${result.publisher || 'Unknown Publisher'} ${result.year ? '‚Ä¢ ' + result.year : ''}</p>
                    `;
                }
                
                // Call valuation if function exists
                if (window.calculateGradingRecommendation && typeof window.calculateGradingRecommendation === 'function') {
                    await window.calculateGradingRecommendation(result);
                }
                
            } catch (error) {
                console.error('Grading error:', error);
                if (gradeResultBig) gradeResultBig.textContent = 'Error';
                if (gradeResultLabel) gradeResultLabel.textContent = 'Failed to analyze';
                if (defectsList) {
                    defectsList.innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p><p style="color: var(--text-muted); margin-top: 0.5rem;">Please try again or contact support if the issue persists.</p>`;
                }
            }
        };
    </script>
    
    <!-- Footer -->
    <footer style="text-align: center; padding: 20px 0; margin-top: 40px; color: var(--text-secondary); font-size: 13px; border-top: 1px solid var(--border-color);">
        <div style="margin-bottom: 8px;">
            <a href="/cdn-cgi/l/email-protection#592a2c2929362b2d192a35383b2e362b2d3120773a3634" style="color: var(--text-secondary); text-decoration: none; margin: 0 12px;">Contact</a>
            <a href="/privacy.html" style="color: var(--text-secondary); text-decoration: none; margin: 0 12px;">Privacy</a>
            <a href="/terms.html" style="color: var(--text-secondary); text-decoration: none; margin: 0 12px;">Terms</a>
        </div>
        <div>Powered by <a href="https://collectioncalc.com" style="color: var(--primary); text-decoration: none;">CollectionCalc</a>‚Ñ¢